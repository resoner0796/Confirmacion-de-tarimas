<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Tarimas Confirmadas - CORNING</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
  color: #FFFFFF;
  margin: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  flex-direction: column;
}
.brand-title {
  font-family: 'Times New Roman', Times, serif;
  font-size: 42px;
  color: white;
  margin: 0 auto 10px auto;
  text-align: center;
}
.card {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  padding: 25px;
  border-radius: 20px;
  text-align: center;
  width: 90%;
  max-width: 550px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}
input, select {
  width: calc(100% - 20px);
  padding: 10px;
  margin: 8px 0;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(255,255,255,0.15);
  color: #fff;
}
button {
  width: 100%;
  padding: 15px;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  margin-top: 10px;
  font-weight: bold;
  color: #fff;
}
.btn-primary { background-color: rgba(0,122,255,0.6); }
.btn-green { background-color: rgba(76,175,80,0.6); }
.btn-danger { background-color: rgba(255,59,48,0.6); }
.btn-orange { background-color: rgba(255,193,7,0.7); color: #000; }
.btn-blue { background-color: rgba(0, 150, 255,0.6); }
#statusMessage { margin-top: 15px; font-weight: bold; }
ul { list-style: none; padding: 0; text-align: left; }
li { background: rgba(255,255,255,0.1); margin-bottom: 6px; padding: 8px; border-radius: 8px; }
.user-actions { display: flex; gap: 5px; margin-top: 5px; }
.tarimaBox { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 8px; margin: 5px 0; }
#modalContainer {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.6);
  justify-content:center;
  align-items:center;
  z-index:1000;
}
#modalContent {
  background:#1e1e1e;
  padding:20px;
  border-radius:12px;
  max-width:500px;
  width:90%;
  color:#fff;
  position:relative;
  max-height: 90vh;
  overflow-y: auto;
}
#modalClose {
  position:absolute;
  top:10px;
  right:15px;
  cursor:pointer;
  font-weight:bold;
}
details summary { cursor:pointer; }
</style>
</head>
<body>

<div id="app"></div>

<!-- MODAL -->
<div id="modalContainer">
  <div id="modalContent">
    <span id="modalClose">‚úñÔ∏è</span>
    <div id="modalBody"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, setDoc, doc, deleteDoc,
  query, orderBy, Timestamp 
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDtlj3ppT9WBGMR60SZx0TZmAo3BXQWDX0",
  authDomain: "rastreador-de-ordenes.firebaseapp.com",
  projectId: "rastreador-de-ordenes",
  storageBucket: "rastreador-de-ordenes.firebasestorage.app",
  messagingSenderId: "956052823395",
  appId: "1:956052823395:web:ca6127628e1dcf423cc756"
};
const appFB = initializeApp(firebaseConfig);
const db = getFirestore(appFB);

const SUPER_ADMIN_GAFETE = "528734";
let usuarioActual = null;
let tarimaActual = null;
let cajasTarima = [];
const appDiv = document.getElementById('app');

// MODAL
function abrirModal(html){ 
  document.getElementById('modalBody').innerHTML=html; 
  document.getElementById('modalContainer').style.display='flex'; 
}
document.getElementById('modalClose').onclick = ()=>{ document.getElementById('modalContainer').style.display='none'; };

// UTILS
function updateStatus(msg,type='info'){ 
  const el=document.getElementById('statusMessage'); 
  if(!el) return; 
  el.textContent=msg; 
  if(type==='success') el.style.color='#4CAF50'; 
  else if(type==='error') el.style.color='#FF5252'; 
  else el.style.color='#9CA3AF'; 
}
function setView(html){ appDiv.innerHTML=html; }

// LOGIN
function mostrarLogin(){
  setView(`
    <p class="brand-title">CORNING</p>
    <div class="card">
      <h2>üîê Iniciar Sesi√≥n</h2>
      <p>Escanea o ingresa tu n√∫mero de gafete:</p>
      <input id="gafeteInput" type="text" placeholder="N√∫mero de gafete">
      <button id="btnLogin" class="btn-primary">Ingresar</button>
      <div id="statusMessage"></div>
    </div>
  `);
  document.getElementById('btnLogin').onclick=verificarGafete;
  document.getElementById('gafeteInput').addEventListener('keypress',e=>{ if(e.key==='Enter') verificarGafete(); });
}

async function verificarGafete(){
  const gafete=document.getElementById('gafeteInput').value.trim();
  if(!gafete){ updateStatus("Ingresa tu gafete",'error'); return; }
  try{
    const snapshot = await getDocs(collection(db,"users"));
    let userData = null;
    snapshot.forEach(d=>{ const data=d.data(); if(data.gafete===gafete) userData=data; });
    if(!userData && gafete!==SUPER_ADMIN_GAFETE){ updateStatus("‚ùå Usuario no encontrado",'error'); return; }
    if(gafete===SUPER_ADMIN_GAFETE && !userData){ userData={nombre:"Super Admin", gafete, rol:"administrador"}; await setDoc(doc(db,"users",gafete),userData);}
    usuarioActual=userData;
    updateStatus(`Bienvenido ${userData.nombre}`,'success');
    setTimeout(()=>{ usuarioActual.rol==="administrador"?mostrarAdministracion():mostrarConfirmacionTarimas(); },1000);
  }catch(e){ console.error(e); updateStatus("Error al conectar con Firestore",'error'); }
}

// ADMIN
async function mostrarAdministracion(){
  setView(`
    <p class="brand-title">CORNING</p>
    <div class="card">
      <h2>‚öôÔ∏è Administraci√≥n</h2>
      <input id="nombreUsuario" placeholder="Nombre del empleado">
      <input id="gafeteUsuario" placeholder="N√∫mero de gafete">
      <select id="rolUsuario">
        <option value="empleado">Empleado</option>
        <option value="administrador">Administrador</option>
      </select>
      <button id="btnAgregar" class="btn-green">üíæ Agregar Usuario</button>
      <hr>
      <h4>Usuarios Registrados:</h4>
      <ul id="listaUsuarios"></ul>
      <hr>
      <button id="btnSalir" class="btn-danger">‚ùå Cerrar Sesi√≥n</button>
      <div id="statusMessage"></div>
    </div>
  `);
  document.getElementById('btnAgregar').onclick=agregarUsuario;
  document.getElementById('btnSalir').onclick=cerrarSesion;
  cargarUsuarios();
}

async function cargarUsuarios(){
  const lista=document.getElementById('listaUsuarios'); lista.innerHTML='<li>Cargando...</li>';
  const snapshot=await getDocs(collection(db,"users"));
  let html=''; snapshot.forEach(docu=>{
    const data=docu.data();
    html+=`<li>${data.nombre} (${data.rol}) - Gafete: ${data.gafete}
      <div class="user-actions">
        <button class="btn-blue" onclick="editarUsuario('${docu.id}','${data.nombre}','${data.gafete}','${data.rol}')">‚úèÔ∏è Editar</button>
        <button class="btn-danger" onclick="eliminarUsuario('${docu.id}')">‚ùå Eliminar</button>
      </div>
    </li>`;
  });
  lista.innerHTML=html || '<li>No hay usuarios registrados.</li>';
}

async function agregarUsuario(){
  const nombre=document.getElementById('nombreUsuario').value.trim();
  const gafete=document.getElementById('gafeteUsuario').value.trim();
  const rol=document.getElementById('rolUsuario').value;
  if(!nombre||!gafete){ updateStatus('‚ùå Completa todos los campos','error'); return; }
  await setDoc(doc(db,"users",gafete),{nombre,gafete,rol});
  updateStatus('‚úÖ Usuario agregado','success');
  document.getElementById('nombreUsuario').value='';
  document.getElementById('gafeteUsuario').value='';
  cargarUsuarios();
}

window.editarUsuario=function(id,nombre,gafete,rol){
  const html=`<h3>Editar Usuario</h3>
    <input id="editNombre" value="${nombre}" placeholder="Nombre" style="width:100%;margin:5px 0;">
    <input id="editGafete" value="${gafete}" placeholder="Gafete" style="width:100%;margin:5px 0;">
    <select id="editRol" style="width:100%;margin:5px 0;">
      <option value="empleado" ${rol==='empleado'?'selected':''}>Empleado</option>
      <option value="administrador" ${rol==='administrador'?'selected':''}>Administrador</option>
    </select>
    <button class="btn-green" id="btnGuardar">üíæ Guardar Cambios</button>
  `;
  abrirModal(html);
  document.getElementById('btnGuardar').onclick=async()=>{
    const nuevoNombre=document.getElementById('editNombre').value.trim();
    const nuevoGafete=document.getElementById('editGafete').value.trim();
    const nuevoRol=document.getElementById('editRol').value;
    if(!nuevoNombre||!nuevoGafete){ alert('Completa todos los campos'); return; }
    await setDoc(doc(db,"users",nuevoGafete),{nombre:nuevoNombre,gafete:nuevoGafete,rol:nuevoRol});
    cargarUsuarios(); document.getElementById('modalContainer').style.display='none';
    updateStatus('‚úÖ Usuario editado','success');
  };
}

window.eliminarUsuario=async function(id){
  if(id===SUPER_ADMIN_GAFETE){ alert("No puedes eliminar al Super Admin."); return; }
  await deleteDoc(doc(db,"users",id));
  cargarUsuarios();
}

// TARIMAS
function mostrarConfirmacionTarimas(){
  setView(`
    <p class="brand-title">CORNING</p>
    <div class="card">
      <h2>‚úÖ Registrar Tarima</h2>
      <button id="btnNuevaTarima" class="btn-orange">‚ûï Crear Nueva Tarima</button>
      <h4 id="folioActual"></h4>
      <input id="codigoTarima" placeholder="Escanear BX...">
      <button id="btnEscanear" class="btn-green">Agregar Caja</button>
      <hr>
      <h4>Cajas agrupadas por orden:</h4>
      <ul id="listaConfirmadas"></ul>
      <p id="totalCajas">Total: 0 cajas</p>
      <hr>
      <button id="btnConfirmar" class="btn-primary">‚úÖ Confirmar Tarima</button>
      <button id="btnVerTarimas" class="btn-blue">üì¶ Tarimas Confirmadas</button>
      <button id="btnSalir" class="btn-danger">‚ùå Cerrar Sesi√≥n</button>
      <div id="statusMessage"></div>
    </div>
  `);
  document.getElementById("btnNuevaTarima").onclick=crearNuevaTarima;
  document.getElementById("btnEscanear").onclick=escanearCaja;
  document.getElementById("btnConfirmar").onclick=confirmarTarima;
  document.getElementById("btnVerTarimas").onclick=verTarimasConfirmadas;
  document.getElementById('codigoTarima').addEventListener('keypress',e=>{ if(e.key==='Enter') escanearCaja(); });
  document.getElementById('btnSalir').onclick=cerrarSesion;
  renderTarima();
}

function renderTarima(){
  const lista=document.getElementById("listaConfirmadas");
  const grouped={};
  cajasTarima.forEach(c=>{
    if(!grouped[c.numeroOrden]) grouped[c.numeroOrden]=[];
    grouped[c.numeroOrden].push(c.codigoCaja);
  });
  let html="";
  Object.entries(grouped).forEach(([orden,cajas])=>{
    const ids=cajas.map(c=>`<li>${c} <button onclick="eliminarCaja('${c}')" class="btn-danger">‚ùå</button></li>`).join("");
    html+=`<li><details><summary>Orden: ${orden} (${cajas.length} cajas)</summary><ul>${ids}</ul></details></li>`;
  });
  lista.innerHTML=html || "<li>Sin cajas escaneadas</li>";
  document.getElementById("totalCajas").textContent=`Total: ${cajasTarima.length} cajas`;
}

function eliminarCaja(codigo){
  cajasTarima=cajasTarima.filter(c=>c.codigoCaja!==codigo);
  renderTarima();
}
window.eliminarCaja=eliminarCaja;

async function crearNuevaTarima(){
  const folio=await generarNuevoFolio();
  tarimaActual={folio,cajas:[]};
  cajasTarima=[];
  updateStatus(`Tarima ${folio} lista para escanear`,'success');
  renderTarima();
}

async function escanearCaja(){
  const codigo=document.getElementById("codigoTarima").value.trim().toUpperCase();
  if(!codigo.startsWith("BX")){ updateStatus("‚ùå El c√≥digo debe empezar con BX",'error'); return; }
  const orden=codigo.slice(2,12);
  cajasTarima.push({codigoCaja:codigo,numeroOrden:orden});
  document.getElementById("codigoTarima").value='';
  renderTarima();
}

async function confirmarTarima(){
  if(!tarimaActual||cajasTarima.length===0){ updateStatus("‚ùå No hay tarima activa o sin cajas",'error'); return; }
  try{
    await addDoc(collection(db,"tarimas_confirmadas"),{
      folio:tarimaActual.folio,
      usuario:usuarioActual.nombre,
      gafete:usuarioActual.gafete,
      fechaHora:Timestamp.now(),
      cajas:cajasTarima
    });
    updateStatus(`‚úÖ Tarima ${tarimaActual.folio} confirmada`,'success');
    cajasTarima=[]; tarimaActual=null; renderTarima();
  }catch(err){ console.error(err); updateStatus("‚ùå Error al guardar tarima",'error'); }
}

async function generarNuevoFolio(){
  const snapshot=await getDocs(collection(db,"tarimas_confirmadas"));
  let max=0;
  snapshot.forEach(d=>{
    const f=d.data().folio;
    if(f && f.startsWith("TAR-")){ const n=parseInt(f.split("-")[1]); if(n>max) max=n; }
  });
  const siguiente=(max+1).toString().padStart(3,"0");
  return `TAR-${siguiente}`;
}

async function verTarimasConfirmadas(){
  const q=query(collection(db,"tarimas_confirmadas"),orderBy("folio","desc"));
  const snapshot=await getDocs(q);
  let html="";
  snapshot.forEach(d=>{
    const data=d.data();
    if(data.gafete===usuarioActual.gafete){
      const fecha=data.fechaHora.toDate();
      const grouped={};
      data.cajas.forEach(c=>{
        if(!grouped[c.numeroOrden]) grouped[c.numeroOrden]=[];
        grouped[c.numeroOrden].push(c.codigoCaja);
      });
      let detalle="";
      Object.entries(grouped).forEach(([orden,cajas])=>{
        const ids=cajas.map(c=>`<li>${c}</li>`).join("");
        detalle+=`<details><summary>Orden: ${orden} (${cajas.length} cajas)</summary><ul>${ids}</ul></details>`;
      });
      html+=`<div class="tarimaBox"><details><summary>${data.folio}</summary>
        <p>Confirmado: ${fecha.toLocaleString()}</p>${detalle}</details></div>`;
    }
  });
  abrirModal(html||"<p>No hay tarimas confirmadas</p>");
}

function cerrarSesion(){ usuarioActual=null; mostrarLogin(); }

mostrarLogin();
</script>
</body>
</html>