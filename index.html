<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Tarimas Confirmadas - CORNING</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #FFFFFF;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      flex-direction: column;
    }
    .brand-title {
      font-family: 'Times New Roman', Times, serif;
      font-size: 42px;
      color: white;
      margin: 0 auto 10px auto;
      text-align: center;
    }
    .card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 25px;
      border-radius: 20px;
      text-align: center;
      width: 90%;
      max-width: 550px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    input, select {
      width: calc(100% - 20px);
      padding: 10px;
      margin: 8px 0;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.15);
      color: #fff;
    }
    button {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: bold;
      color: #fff;
    }
    .btn-primary { background-color: rgba(0,122,255,0.6); }
    .btn-green { background-color: rgba(76,175,80,0.6); }
    .btn-danger { background-color: rgba(255,59,48,0.6); }
    .btn-orange { background-color: rgba(255,193,7,0.7); color: #000; }
    .btn-blue { background-color: rgba(0, 150, 255,0.6); }
    #statusMessage { margin-top: 15px; font-weight: bold; }
    ul { list-style: none; padding: 0; text-align: left; }
    li { background: rgba(255,255,255,0.1); margin-bottom: 6px; padding: 8px; border-radius: 8px; }
    .user-actions { display: flex; gap: 5px; margin-top: 5px; }
    .tarimaBox { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 8px; margin: 5px 0; }
    /* MODAL */
    #modalContainer {
      display:none;
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.6);
      justify-content:center;
      align-items:center;
      z-index:1000;
    }
    #modalContent {
      background:#1e1e1e;
      padding:20px;
      border-radius:12px;
      max-width:500px;
      width:90%;
      color:#fff;
      position:relative;
      max-height: 90vh;
      overflow-y: auto;
    }
    #modalClose {
      position:absolute;
      top:10px;
      right:15px;
      cursor:pointer;
      font-weight:bold;
    }
  </style>
</head>
<body>

  <div id="app"></div>

  <!-- MODAL -->
  <div id="modalContainer">
    <div id="modalContent">
      <span id="modalClose">‚úñÔ∏è</span>
      <div id="modalBody"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, getDocs, setDoc, doc, deleteDoc,
      query, orderBy, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDtlj3ppT9WBGMR60SZx0TZmAo3BXQWDX0",
      authDomain: "rastreador-de-ordenes.firebaseapp.com",
      projectId: "rastreador-de-ordenes",
      storageBucket: "rastreador-de-ordenes.firebasestorage.app",
      messagingSenderId: "956052823395",
      appId: "1:956052823395:web:ca6127628e1dcf423cc756"
    };

    const appFB = initializeApp(firebaseConfig);
    const db = getFirestore(appFB);

    const SUPER_ADMIN_GAFETE = "528734";
    let usuarioActual = null;
    let tarimaActual = null;
    let cajasTarima = [];
    const appDiv = document.getElementById('app');

    // MODAL FUNCTIONS
    function abrirModal(html) {
      document.getElementById('modalBody').innerHTML = html;
      document.getElementById('modalContainer').style.display = 'flex';
    }
    document.getElementById('modalClose').onclick = () => {
      document.getElementById('modalContainer').style.display = 'none';
    };

    function updateStatus(msg, type = 'info') {
      const el = document.getElementById('statusMessage');
      if (!el) return;
      el.textContent = msg;
      if (type === 'success') el.style.color = '#4CAF50';
      else if (type === 'error') el.style.color = '#FF5252';
      else el.style.color = '#9CA3AF';
    }

    function setView(html) { appDiv.innerHTML = html; }

    // LOGIN
    function mostrarLogin() {
      setView(`
        <p class="brand-title">CORNING</p>
        <div class="card">
          <h2>üîê Iniciar Sesi√≥n</h2>
          <p>Escanea o ingresa tu n√∫mero de gafete:</p>
          <input id="gafeteInput" type="text" placeholder="N√∫mero de gafete">
          <button id="btnLogin" class="btn-primary">Ingresar</button>
          <div id="statusMessage"></div>
        </div>
      `);
      document.getElementById('btnLogin').onclick = verificarGafete;
      document.getElementById('gafeteInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') verificarGafete();
      });
    }

    async function verificarGafete() {
      const gafete = document.getElementById('gafeteInput').value.trim();
      if (!gafete) { updateStatus("Ingresa tu gafete", 'error'); return; }

      try {
        const snapshot = await getDocs(collection(db, "users"));
        let userData = null;
        snapshot.forEach(docu => { const data = docu.data(); if (data.gafete===gafete) userData=data; });

        if (!userData && gafete!==SUPER_ADMIN_GAFETE) { updateStatus("‚ùå Usuario no encontrado.",'error'); return; }

        if (gafete===SUPER_ADMIN_GAFETE && !userData) {
          userData = {nombre:"Super Admin", gafete, rol:"administrador"};
          await setDoc(doc(db,"users",gafete), userData);
        }

        usuarioActual = userData;
        updateStatus(`Bienvenido ${userData.nombre}`, 'success');
        setTimeout(()=>{ usuarioActual.rol==="administrador"?mostrarAdministracion():mostrarConfirmacionTarimas(); },1000);
      } catch(e){ console.error(e); updateStatus("Error al conectar con Firestore.",'error'); }
    }

    // ADMIN
    async function mostrarAdministracion() {
      setView(`
        <p class="brand-title">CORNING</p>
        <div class="card">
          <h2>‚öôÔ∏è Administraci√≥n</h2>
          <input id="nombreUsuario" placeholder="Nombre del empleado">
          <input id="gafeteUsuario" placeholder="N√∫mero de gafete">
          <select id="rolUsuario">
            <option value="empleado">Empleado</option>
            <option value="administrador">Administrador</option>
          </select>
          <button id="btnAgregar" class="btn-green">üíæ Agregar Usuario</button>
          <hr>
          <h4>Usuarios Registrados:</h4>
          <ul id="listaUsuarios"></ul>
          <hr>
          <button id="btnSalir" class="btn-danger">‚ùå Cerrar Sesi√≥n</button>
          <div id="statusMessage"></div>
        </div>
      `);
      document.getElementById('btnAgregar').onclick=agregarUsuario;
      document.getElementById('btnSalir').onclick=cerrarSesion;
      cargarUsuarios();
    }

    async function cargarUsuarios() {
      const lista = document.getElementById('listaUsuarios');
      lista.innerHTML = '<li>Cargando...</li>';
      const snapshot = await getDocs(collection(db,"users"));
      let html='';
      snapshot.forEach(docu=>{
        const data = docu.data();
        html += `<li>${data.nombre} (${data.rol}) - Gafete: ${data.gafete}
          <div class="user-actions">
            <button class="btn-blue" onclick="editarUsuario('${docu.id}','${data.nombre}','${data.gafete}','${data.rol}')">‚úèÔ∏è Editar</button>
            <button class="btn-danger" onclick="eliminarUsuario('${docu.id}')">‚ùå Eliminar</button>
          </div>
        </li>`;
      });
      lista.innerHTML = html || '<li>No hay usuarios registrados.</li>';
    }

    async function agregarUsuario() {
      const nombre = document.getElementById('nombreUsuario').value.trim();
      const gafete = document.getElementById('gafeteUsuario').value.trim();
      const rol = document.getElementById('rolUsuario').value;
      if (!nombre || !gafete) { updateStatus('‚ùå Completa todos los campos.', 'error'); return; }
      await setDoc(doc(db,"users",gafete),{nombre,gafete,rol});
      updateStatus('‚úÖ Usuario agregado.', 'success');
      document.getElementById('nombreUsuario').value='';
      document.getElementById('gafeteUsuario').value='';
      cargarUsuarios();
    }

    window.editarUsuario = function(id,nombre,gafete,rol){
      const html = `
        <h3>Editar Usuario</h3>
        <input id="editNombre" placeholder="Nombre" value="${nombre}" style="width:100%;margin:5px 0;">
        <input id="editGafete" placeholder="Gafete" value="${gafete}" style="width:100%;margin:5px 0;">
        <select id="editRol" style="width:100%;margin:5px 0;">
          <option value="empleado" ${rol==='empleado'?'selected':''}>Empleado</option>
          <option value="administrador" ${rol==='administrador'?'selected':''}>Administrador</option>
        </select>
        <button id="saveEdit" class="btn-green">Guardar</button>
      `;
      abrirModal(html);
      document.getElementById('saveEdit').onclick = async ()=>{
        const nuevoNombre = document.getElementById('editNombre').value.trim();
        const nuevoGafete = document.getElementById('editGafete').value.trim();
        const nuevoRol = document.getElementById('editRol').value;
        if(!nuevoNombre||!nuevoGafete){ alert('Completa todos los campos'); return; }
        await setDoc(doc(db,"users",nuevoGafete),{nombre:nuevoNombre,gafete:nuevoGafete,rol:nuevoRol});
        if(nuevoGafete!==gafete) await deleteDoc(doc(db,"users",gafete));
        cargarUsuarios();
        document.getElementById('modalContainer').style.display='none';
      };
    };

    window.eliminarUsuario = async function(id){
      abrirModal(`<h3>¬øEliminar usuario?</h3><button id="confirmDel" class="btn-danger">S√≠, eliminar</button>`);
      document.getElementById('confirmDel').onclick=async()=>{
        await deleteDoc(doc(db,"users",id));
        cargarUsuarios();
        document.getElementById('modalContainer').style.display='none';
      };
    };

    function cerrarSesion() { usuarioActual=null; mostrarLogin(); }

    // TARIMAS CONFIRMADAS
    async function mostrarConfirmacionTarimas() {
      setView(`<p class="brand-title">CORNING</p>
      <div class="card">
        <h2>üì¶ Tarimas Confirmadas</h2>
        <button id="btnVerTarimas" class="btn-orange">Ver Tarimas Confirmadas</button>
        <button id="btnSalir" class="btn-danger">‚ùå Cerrar Sesi√≥n</button>
      </div>`);
      document.getElementById('btnSalir').onclick=cerrarSesion;
      document.getElementById('btnVerTarimas').onclick=async()=>{
        const snap = await getDocs(collection(db,"tarimas"));
        let html='';
        snap.forEach(docu=>{
          const data=docu.data();
          html+=`<div class="tarimaBox">
            <b>${data.id}</b>
            <button class="btn-blue" onclick="abrirDetalleTarima('${docu.id}')">Ver Detalle</button>
          </div>`;
        });
        abrirModal(html || '<p>No hay tarimas confirmadas</p>');
      };
    }

    window.abrirDetalleTarima=async function(id){
      const docu = await getDocs(collection(db,"tarimas"));
      let contenido='';
      docu.forEach(d=>{
        if(d.id===id){
          const t=d.data();
          contenido+=`<h3>${t.id} - Detalle</h3>`;
          contenido+=`<p>Fecha: ${t.fecha?.toDate?.()?.toLocaleString()||''}</p>`;
          contenido+=`<ul>`;
          t.cajas?.forEach(c=>{ contenido+=`<li>${c.BXID} - Cantidad: ${c.cantidad}</li>`; });
          contenido+=`</ul>`;
        }
      });
      abrirModal(contenido || '<p>Detalles no encontrados</p>');
    };

    mostrarLogin();
  </script>

</body>
</html>