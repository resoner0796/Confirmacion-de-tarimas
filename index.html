<!DOCTYPE html>
<html lang="es">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <title>RecolecciÃ³n - Pro Final</title>
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â Â 
    Â  Â  <style>
Â  Â  Â  Â  /* Estilos Generales y de Fondo */
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
Â  Â  Â  Â  Â  Â  color: #FFFFFF;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  background-attachment: fixed;
Â  Â  Â  Â  }

Â  Â  Â  Â  .brand-title {
Â  Â  Â  Â  Â  Â  font-family: 'Times New Roman', Times, serif;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-size: clamp(40px, 3vw, 40px);
Â  Â  Â  Â  Â  Â  font-weight: normal;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  letter-spacing: 2px;
Â  Â  Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Estilo Glassmorphism para la Tarjeta Principal */
Â  Â  Â  Â  .card {
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.1);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(12px);
Â  Â  Â  Â  Â  Â  -webkit-backdrop-filter: blur(12px);
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(255, 255, 255, 0.2);
Â  Â  Â  Â  Â  Â  padding: 25px;
Â  Â  Â  Â  Â  Â  margin: 20px auto;
Â  Â  Â  Â  Â  Â  max-width: 600px;
Â  Â  Â  Â  Â  Â  width: 90%;
Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* TÃ­tulos y texto */
Â  Â  Â  Â  h2, h3, h4 { margin: 10px 0; font-weight: 500; }
Â  Â  Â  Â  h2 { font-size: 1.8em; }
Â  Â  Â  Â  h3 { font-size: 1.4em; }
Â  Â  Â  Â  small { color: #cccccc; }
Â  Â  Â  Â  hr { border-color: rgba(255,255,255,0.2); margin: 20px 0; border-style: solid; border-width: 1px 0 0 0;}


Â  Â  Â  Â  /* Estilos de Inputs y Selects con efecto Glass */
Â  Â  Â  Â  input, select {
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  width: calc(100% - 30px);
Â  Â  Â  Â  Â  Â  margin: 12px 0;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(255, 255, 255, 0.3);
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.15);
Â  Â  Â  Â  Â  Â  color: #FFFFFF;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  transition: all 0.2s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  input:focus, select:focus {
Â  Â  Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(0, 122, 255, 0.8);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 10px rgba(0, 122, 255, 0.5);
Â  Â  Â  Â  }
Â  Â  Â  Â  input::placeholder { color: #a0a0a0; }

Â  Â  Â  Â  /* Estilos de Botones con efecto Glass */
Â  Â  Â  Â  button {
Â  Â  Â  Â  Â  Â  padding: 15px 20px;
Â  Â  Â  Â  Â  Â  margin: 10px 0;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  border: 1px solid transparent;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  color: #FFFFFF;
Â  Â  Â  Â  }
Â  Â  Â  Â  button.btn-primary { background-color: rgba(0, 122, 255, 0.6); border-color: rgba(0, 122, 255, 0.8); }
Â  Â  Â  Â  button.btn-green { background-color: rgba(76, 175, 80, 0.6); border-color: rgba(76, 175, 80, 0.8); }
Â  Â  Â  Â  button.btn-orange { background-color: rgba(255, 193, 7, 0.6); border-color: rgba(255, 193, 7, 0.8); color: #000; }
Â  Â  Â  Â  button.btn-danger { background-color: rgba(255, 59, 48, 0.6); border-color: rgba(255, 59, 48, 0.8); }
Â  Â  Â  Â  button.btn-secondary { background-color: rgba(108, 117, 125, 0.5); border-color: rgba(108, 117, 125, 0.7); }
Â  Â  Â  Â  button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
Â  Â  Â  Â  button:active { transform: translateY(0); filter: brightness(0.9); }

Â  Â  Â  Â  /* Estilos de Listas para UI Limpia y Desplegable */
Â  Â  Â  Â  { padding-left: 0; list-style: none; }
Â  Â  Â  Â  .tarima-item {
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.1);
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  word-wrap: break-word;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â     align-items: flex-start;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .tarima-item:hover {
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.15);
Â  Â  Â  Â  }
Â  Â  Â  Â  .tarima-item-header, .tarima-item-header-simple {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .tarima-detalles-desplegables {
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  Â  Â  padding-top: 15px;
Â  Â  Â  Â  Â  Â  border-top: 1px solid rgba(255, 255, 255, 0.2);
Â  Â  Â  Â  }

Â  Â  Â  Â  .edit-delete-btns {Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  gap: 10px;Â 
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .edit-delete-btns button {Â 
Â  Â  Â  Â  Â  Â  width: auto;Â 
Â  Â  Â  Â  Â  Â  padding: 8px 15px;Â 
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  }
Â  Â  Â  Â  .list-item-btn {
Â  Â  Â  Â  Â  Â  width: auto !important;
Â  Â  Â  Â  Â  Â  padding: 8px 15px !important;
Â  Â  Â  Â  Â  Â  margin: 0 !important;
Â  Â  Â  Â  Â  Â  flex-shrink: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .workflow-status { font-size: 0.9em; width: 100%; margin-top: 8px; font-weight: bold; color: #E5E7EB;}
Â  Â  Â  Â Â 
Â  Â  Â  Â  .workflow-timestamps { font-size: 0.8em; color: #9CA3AF; margin-top: 8px; }
Â  Â  Â  Â  .workflow-timestamps ul {
Â  Â  Â  Â  Â  Â  list-style: none;
Â  Â  Â  Â  Â  Â  padding-left: 10px;
Â  Â  Â  Â  Â  Â  margin: 5px 0 0 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .workflow-timestamps li {
Â  Â  Â  Â  Â  Â  background: none;
Â  Â  Â  Â  Â  Â  padding: 2px 0;
Â  Â  Â  Â  Â  Â  margin-bottom: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .cajas-desplegables {
Â  Â  Â  Â  Â  Â  list-style: none;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  Â  Â  background-color: rgba(0, 0, 0, 0.25);
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  max-height: 200px;
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  Â  Â  box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
Â  Â  Â  Â  }
Â  Â  Â  Â  .cajas-desplegables h4 {
Â  Â  Â  Â  Â  Â  margin-top: 0;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  font-size: 1em;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â  .cajas-desplegables ul {
Â  Â  Â  Â  Â  Â  Â padding-left: 0;
Â  Â  Â  Â  Â  Â  Â list-style: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  .cajas-desplegables li {
Â  Â  Â  Â  Â  Â  background: transparent;
Â  Â  Â  Â  Â  Â  padding: 8px 5px;
Â  Â  Â  Â  Â  Â  margin-bottom: 0;
Â  Â  Â  Â  Â  Â  font-size: 0.9em;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  }
        
        /* --- ERROR 'OS' CORREGIDO AQUÃ --- */
        /* Se eliminÃ³ el 'OS' y las lÃ­neas duplicadas que rompÃ­an el CSS */

Â  Â  Â  Â  .cajas-desplegables li:last-child {
Â  Â  Â  Â  Â  Â  border-bottom: none;
Â  Â  Â  Â  }


Â  Â  Â  Â  /* Mensajes de Estado */
Â  Â  Â  Â  #statusMessage { padding: 12px; margin: 15px 0; border-radius: 10px; font-weight: bold; text-align: center; }
Â  Â  Â  Â  .status-success { background: rgba(52, 199, 89, 0.7); border: 1px solid rgba(52, 199, 89, 1); }
Â  Â  Â  Â  .status-info { background: rgba(90, 200, 250, 0.7); border: 1px solid rgba(90, 200, 250, 1); }
Â  Â  Â  Â  .status-error { background: rgba(255, 59, 48, 0.7); border: 1px solid rgba(255, 59, 48, 1); }

Â  Â  Â  Â  /* Estilos para Modales Personalizados */
Â  Â  Â  Â  .modal-backdrop {
Â  Â  Â  Â  Â  Â  position: fixed; top: 0; left: 0;
Â  Â  Â  Â  Â  Â  width: 100%; height: 100%;
Â  Â  Â  Â  Â  Â  background-color: rgba(0, 0, 0, 0.5);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
Â  Â  Â  Â  Â  Â  display: flex; justify-content: center; align-items: center;
Â  Â  Â  Â  Â  Â  z-index: 200; opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-content {
Â  Â  Â  Â  Â  Â  background: rgba(50, 50, 50, 0.7);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(255, 255, 255, 0.2);
Â  Â  Â  Â  Â  Â  padding: 25px; max-width: 400px;
Â  Â  Â  Â  Â  Â  width: 90%; border-radius: 20px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  transform: scale(0.9); transition: transform 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-backdrop.visible { opacity: 1; pointer-events: all; }
Â  Â  Â  Â  .modal-backdrop.visible .modal-content { transform: scale(1); }
Â  Â  Â  Â  .modal-header h3 { margin: 0 0 15px 0; }
Â  Â  Â  Â  .modal-body p { margin: 0; line-height: 1.5; }
Â  Â  Â  Â  .modal-body div { margin-bottom: 0; }
Â  Â  Â  Â  .modal-body input { margin-top: 0; }
Â  Â  Â  Â  .modal-footer { display: flex; gap: 10px; margin-top: 20px;}
Â  Â  Â  Â  .modal-footer button { margin: 0; flex-grow: 1; }

Â  Â  Â  Â  /* Estilos del Modal del EscÃ¡ner */
Â  Â  Â  Â  #scannerModal {
Â  Â  Â  Â  Â  Â  position: fixed; top: 0; left: 0;
Â  Â  Â  Â  Â  Â  width: 100%; height: 100%;
Â  Â  Â  Â  Â  Â  background-color: rgba(0, 0, 0, 0.5);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
Â  Â  Â  Â  Â  Â  display: none; justify-content: center; align-items: center;
Â  Â  Â  Â  Â  Â  z-index: 100; flex-direction: column;
Â  Â  Â  Â  }
Â  Â  Â  Â  #scannerModal.active { display: flex; }
Â  Â  Â  Â  .scanner-frame-container {
Â  Â  Â  Â  Â  Â  position: relative; width: 90%; max-width: 400px;
Â  Â  Â  Â  Â  Â  aspect-ratio: 1 / 1; border: 2px solid rgba(0, 122, 255, 0.8);
Â  Â  Â  Â  Â  Â  border-radius: 15px; overflow: hidden;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 20px rgba(0, 122, 255, 0.5);
Â  Â  Â  Â  }
Â  Â  Â  Â  #preview { width: 100%; height: 100%; object-fit: cover; }
Â  Â  Â  Â  .scanner-frame::before {
Â  Â  Â  Â  Â  Â  content: ''; position: absolute; top: 0; left: 0;
Â  Â  Â  Â  Â  Â  width: 100%; height: 3px; background-color: #ff3b30;
Â  Â  Â  Â  Â  Â  animation: scan-line 2.5s infinite ease-in-out;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 10px #ff3b30;
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes scan-line { 0%, 100% { top: 0; } 50% { top: calc(100% - 3px); } }

Â  Â  Â  Â  /* Reportes */
Â  Â  Â  Â  .report-filters {
Â  Â  Â  Â  Â  Â  display: grid; gap: 10px; margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  }
Â  Â  Â  Â  @media (min-width: 600px) { .report-filters { grid-template-columns: repeat(2, 1fr); } }
Â  Â  Â  Â  #reporteResumen {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  background: rgba(0,0,0,0.2);
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .resumen-item {
Â  Â  Â  Â  Â  Â  background: rgba(255,255,255,0.1);
Â  Â  Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  font-size: 0.9em;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .pantalla {
Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  transition: opacity 0.5s ease-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  .pantalla.activa { display: flex; flex-direction: column; }

Â  Â  Â  Â  #splashScreen {
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .splash-content {
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .splash-logo-container {
Â  Â  Â  Â  Â  Â  border-radius: 25px;
Â  Â  Â  Â  Â  Â  margin: 20px 0;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.1);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(8px);
Â  Â  Â  Â  Â  Â  -webkit-backdrop-filter: blur(8px);
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(255, 255, 255, 0.15);
Â  Â  Â  Â  Â  Â  box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
Â  Â  Â  Â  }
Â  Â  Â  Â  .splash-logo {
Â  Â  Â  Â  Â  Â  width: 150px;
Â  Â  Â  Â  Â  Â  height: auto;
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  border-radius: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .splash-loading {
Â  Â  Â  Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  Â  Â  Â  color: #9CA3AF;
Â  Â  Â  Â  Â  Â  letter-spacing: 2px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .splash-loading .dot {
Â  Â  Â  Â  Â  Â  animation: blink-dot 1.4s infinite;
Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .splash-loading .dot:nth-child(2) { animation-delay: 0.2s; }
Â  Â  Â  Â  .splash-loading .dot:nth-child(3) { animation-delay: 0.4s; }
Â  Â  Â  Â  @keyframes blink-dot { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }

Â  Â  </style>
Â  Â  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
Â  Â  <script src="https://unpkg.com/@zxing/library@latest"></script>
</head>
<body>
Â  Â Â 
Â  Â  <div id="splashScreen" class="pantalla activa">
Â  Â  Â  Â  <div class="splash-content">
Â  Â  Â  Â  Â  Â  Â <p class="brand-title" style="font-size: clamp(40px, 3vw, 60px);">CORNING</p>
Â  Â  Â  Â  Â  Â  Â <div class="splash-logo-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â <p class="splash-loading">Cargando<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></p>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="pantallaPrincipal" class="pantalla"></div>
Â  Â  <div id="modalContainer"></div>
Â  Â  <div id="scannerModal">
Â  Â  Â  Â  <div class="scanner-frame-container">
Â  Â  Â  Â  Â  Â  <video id="preview"></video>
Â  Â  Â  Â  Â  Â  <div class="scanner-frame"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button id="closeScannerBtn" class="btn-danger" style="width: 90%; max-width: 400px; margin-top: 20px;">âŒ Cerrar</button>
Â  Â  </div>
<script>

Â  Â  document.addEventListener('dblclick', function(e) { e.preventDefault(); }, { passive: false });

Â  Â  const firebaseConfig = {
Â  Â  Â  Â  apiKey: "AIzaSyCPTEu73s2rVIm2VsdTk59kVIOyi1jeyu8",
Â  Â  Â  Â  authDomain: "panel-logistica.firebaseapp.com",
Â  Â  Â  Â  databaseURL: "https://panel-logistica-default-rtdb.firebaseio.com",
Â  Â  Â  Â  projectId: "panel-logistica",
Â  Â  Â  Â  storageBucket: "panel-logistica.appspot.com",
Â  Â  Â  Â  messagingSenderId: "38365879945",
Â  Â  Â  Â  appId: "1:38365879945:web:e2f3590fe77f013dba3058"
Â  Â  };
Â  Â  firebase.initializeApp(firebaseConfig);
Â  Â  const db = firebase.database();

Â  Â  let empleadoActual = null, currentTarima = null, codeReader = null;
Â  Â  let scanning = false, modo = "", cantidadPiezasActual = null;
Â  Â  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
Â  Â  const SUPER_ADMIN_GAFETE = "528734";
Â  Â  let appConfig = { contrasenaTarimas: "BORRAR25", cantidadesPiezas: "1,5,6,12,24,34" };

Â  Â  // --- SISTEMA DE MODALES PERSONALIZADO ---
Â  Â  function mostrarModal(type, title, message, callback) {
Â  Â  Â  Â  const modalContainer = document.getElementById('modalContainer');
Â  Â  Â  Â  const id = 'modal-' + Date.now();
Â  Â  Â  Â  let bodyHtml = (message.startsWith('<')) ? message : `<p>${message}</p>`;
Â  Â  Â  Â  let footerHtml = '';
Â  Â  Â  Â  const closeModal = (value) => {
Â  Â  Â  Â  Â  Â  const modalEl = document.getElementById(id);
Â  Â  Â  Â  Â  Â  modalEl.classList.remove('visible');
Â  Â  Â  Â  Â  Â  setTimeout(() => { modalEl.remove(); if (callback) callback(value); }, 300);
Â  Â  Â  Â  };
Â  Â  Â  Â  if (type === 'prompt') {
Â  Â  Â  Â  Â  Â  bodyHtml += `<input type="password" id="${id}-input" class="modal-input">`;
Â  Â  Â  Â  Â  Â  footerHtml = `<button class="btn-secondary">Cancelar</button><button class="btn-primary">Aceptar</button>`;
Â  Â  Â  Â  } else if (type === 'confirm') {
Â  Â  Â  Â  Â  Â  footerHtml = `<button class="btn-secondary">Cancelar</button><button class="btn-primary">Aceptar</button>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  footerHtml = `<button class="btn-primary">Aceptar</button>`;
Â  Â  Â  Â  }
Â  Â  Â  Â  modalContainer.innerHTML += `<div class="modal-backdrop" id="${id}"><div class="modal-content"><div class="modal-header"><h3>${title}</h3></div><div class="modal-body">${bodyHtml}</div><div class="modal-footer">${footerHtml}</div></div></div>`;
Â  Â  Â  Â  const modalElement = document.getElementById(id);
Â  Â  Â  Â  const buttons = modalElement.querySelectorAll('button');
Â  Â  Â  Â  if (type === 'prompt') {
Â  Â  Â  Â  Â  Â  buttons[0].onclick = () => closeModal(null);
Â  Â  Â  Â  Â  Â  buttons[1].onclick = () => closeModal(document.getElementById(`${id}-input`).value);
Â  Â  Â  Â  Â  Â  document.getElementById(`${id}-input`).focus();
Â  Â  Â  Â  } else if (type === 'confirm') {
Â  Â  Â  Â  Â  Â  buttons[0].onclick = () => closeModal(false);
Â  Â  Â  Â  Â  Â  buttons[1].onclick = () => closeModal(true);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  buttons[0].onclick = () => closeModal(true);
Â  Â  Â  Â  }
Â  Â  Â  Â  setTimeout(() => modalElement.classList.add('visible'), 10);
Â  Â  }
Â  Â Â 
Â  Â  // --- FUNCIONES GENERALES Y DE UI ---
Â  Â  function updateStatus(message, type) {
Â  Â  Â  Â  const statusDiv = document.getElementById("statusMessage");
Â  Â  Â  Â  if (statusDiv) { statusDiv.textContent = message; statusDiv.className = `status-${type}`; }
Â  Â  }

Â  Â  function activarPantalla(id){
Â  Â  Â  Â  document.querySelectorAll('.pantalla').forEach(p => p.classList.remove('activa'));
Â  Â  Â  Â  const pantalla = document.getElementById(id);
Â  Â  Â  Â  if(pantalla) {
Â  Â  Â  Â  Â  Â  pantalla.style.display = 'flex';
Â  Â  Â  Â  Â  Â  pantalla.classList.add('activa');
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function mostrarPantallaInicio() {
Â  Â  Â  Â  const contenedor = document.getElementById("pantallaPrincipal");
Â  Â  Â  Â  contenedor.innerHTML = `<p class="brand-title">CORNING</p><div class="card"><h2>RecolecciÃ³n de Tarimas</h2><p>Seleccione una opciÃ³n para comenzar</p><button onclick="iniciarFlujo('recoleccion')" class="btn-primary">ğŸ“¦ RecolecciÃ³n</button><button onclick="iniciarFlujo('administracion')" class="btn-orange">âš™ï¸ AdministraciÃ³n</button><button onclick="iniciarFlujoVerificacion()" class="btn-secondary">ğŸ” VerificaciÃ³n</button><button onclick="iniciarFlujo('confirmacion')" class="btn-green">âœ… Registrar tarima confirmada</button><div id="statusMessage" style="margin-top: 20px;"></div></div>`;
Â  Â  }

Â  Â  function cerrarSesion() { empleadoActual = null; mostrarPantallaInicio(); }
Â  Â Â 
Â  Â  function determinarTurno(date = new Date()) {
Â  Â  Â  Â  const ahora = new Date(date);
Â  Â  Â  Â  const esTurno1 = (ahora.getHours() > 6 || (ahora.getHours() === 6 && ahora.getMinutes() >= 30)) && (ahora.getHours() < 18 || (ahora.getHours() === 18 && ahora.getMinutes() < 30));
Â  Â  Â  Â  return esTurno1 ? 'Turno 1' : 'Turno 2';
Â  Â  }
Â  Â  function obtenerFechaTurno(date = new Date()) {
Â  Â  Â  Â  const ahora = new Date(date);
Â  Â  Â  Â  let fecha = new Date(ahora);
Â  Â  Â  Â  if (determinarTurno(ahora) === 'Turno 2' && ahora.getHours() < 6) {
Â  Â  Â  Â  Â  Â  fecha.setDate(ahora.getDate() - 1);
Â  Â  Â  Â  }
Â  Â  Â  Â  return `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}-${String(fecha.getDate()).padStart(2, '0')}`;
Â  Â  }
Â  Â Â 
Â  Â  function formatoFechaHora(isoString) {
Â  Â  Â  Â  if (!isoString) return '';
Â  Â  Â  Â  const date = new Date(isoString);
Â  Â  Â  Â  const day = String(date.getDate()).padStart(2, '0');
Â  Â  Â  Â  const month = String(date.getMonth() + 1).padStart(2, '0');
Â  Â  Â  Â  const year = String(date.getFullYear()).slice(-2);
Â  Â  Â  Â  const hours = String(date.getHours()).padStart(2, '0');
Â  Â  Â  Â  const minutes = String(date.getMinutes()).padStart(2, '0');
Â  Â  Â  Â  return `${day}/${month}/${year} ${hours}:${minutes}`;
Â  Â  }

Â  Â  function toggleDetalles(id) {
Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  if (el) {
Â  Â  Â  Â  Â  Â  el.style.display = el.style.display === 'none' ? 'block' : 'none';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // --- SISTEMA DE ACCESO Y AUTENTICACIÃ“N ---
Â  Â  function iniciarFlujo(flujo) {
Â  Â  Â  Â  const titulos = { recoleccion: 'ğŸ“¦ RecolecciÃ³n', administracion: 'âš™ï¸ AdministraciÃ³n', confirmacion: 'âœ… Confirmar Tarima' };
Â  Â  Â  Â  document.getElementById("pantallaPrincipal").innerHTML = `<p class="brand-title">CORNING</p><div class="card"><h2>${titulos[flujo] || 'Iniciar SesiÃ³n'} - Iniciar SesiÃ³n</h2><p>Escanee su gafete para continuar.</p><div id="statusMessage"></div><input type="text" id="gafeteInput" placeholder="Escanear o ingresar gafete">${isMobile ? `<button id="btnEscGafete" class="btn-primary">ğŸ“· Escanear Gafete</button>` : ""}<button onclick="mostrarPantallaInicio()" class="btn-secondary">â¬…ï¸ Regresar</button></div>`;
Â  Â  Â  Â  updateStatus("Esperando escaneo de gafete...", 'info');
Â  Â  Â  Â  const input = document.getElementById("gafeteInput");
Â  Â  Â  Â  input.addEventListener("keypress", e => { if (e.key === "Enter") verificarAcceso(input.value.trim(), flujo); });
Â  Â  Â  Â  if (isMobile) document.getElementById("btnEscGafete").addEventListener("click", () => iniciarEscaneo(`gafete-${flujo}`));
Â  Â  }

Â  Â  function verificarAcceso(gafete, flujo) {
Â  Â  Â  Â  db.ref('users/' + gafete).once('value').then(snapshot => {
Â  Â  Â  Â  Â  Â  const user = snapshot.val();
Â  Â  Â  Â  Â  Â  let rol = user ? user.rol : null;
Â  Â  Â  Â  Â  Â  db.ref('users').once('value').then(usersSnapshot => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!usersSnapshot.exists() && gafete === SUPER_ADMIN_GAFETE) rol = 'administrador';
Â  Â  Â  Â  Â  Â  Â  Â  if (!rol) { updateStatus("âŒ Acceso denegado.", 'error'); setTimeout(mostrarPantallaInicio, 2000); return; }
Â  Â  Â  Â  Â  Â  Â  Â  if (flujo === 'administracion' && rol !== 'administrador') { updateStatus("âŒ No tiene permisos.", 'error'); setTimeout(mostrarPantallaInicio, 2000); return; }
Â  Â  Â  Â  Â  Â  Â  Â  empleadoActual = { id: gafete, rol: rol, nombre: user ? user.nombre : 'Super Admin' };
Â  Â  Â  Â  Â  Â  Â  Â  updateStatus(`Â¡Hola, ${empleadoActual.nombre}!`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (flujo === 'recoleccion') mostrarPantallaOpcionesRecoleccion();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (flujo === 'administracion') mostrarPantallaAdministracion();
                        else if (flujo === 'confirmacion') mostrarPantallaConfirmacion();
Â  Â  Â  Â  Â  Â  Â  Â  }, 1500);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }).catch(err => updateStatus('âŒ Error de conexiÃ³n.', 'error'));
Â  Â  }

Â  Â  // --- MÃ“DULO DE ADMINISTRACIÃ“N (Con ParÃ¡metros) ---
Â  Â  function mostrarPantallaAdministracion() {
Â  Â  Â  Â  document.getElementById("pantallaPrincipal").innerHTML = `<p class="brand-title">CORNING</p><div class="card" style="max-width: 700px;"><h2>âš™ï¸ AdministraciÃ³n</h2><div id="statusMessage"></div><h3>GestiÃ³n de Usuarios</h3><div style="text-align: left; margin-bottom: 10px;"><input type="text" id="adminGafeteInput" placeholder="NÃºmero de Gafete"><input type="text" id="adminNombreInput" placeholder="Nombre del Empleado"><select id="adminRolSelect"><option value="recolector">Recolector</option><option value="administrador">Administrador</option></select></div><button onclick="guardarUsuario()" class="btn-green">ğŸ’¾ Guardar Usuario</button><ul id="listaUsuarios" style="max-height: 200px; overflow-y: auto; margin-top:15px;"></ul><hr><h3>ParÃ¡metros del Sistema</h3><div style="text-align: left;"><label for="paramContrasena">ContraseÃ±a para Editar/Eliminar Tarimas:</label><input type="text" id="paramContrasena"><label for="paramCantidades">Cantidades de Piezas VÃ¡lidas (separadas por coma):</label><input type="text" id="paramCantidades" placeholder="Ej: 1,5,6,12,24,34"></div><button onclick="guardarConfiguracion()" class="btn-primary">ğŸ’¾ Guardar ParÃ¡metros</button><hr><button onclick="cerrarSesion()" class="btn-danger">âŒ Salir</button></div>`;
Â  Â  Â  Â  cargarUsuarios();
Â  Â  Â  Â  cargarConfiguracion();
Â  Â  }
Â  Â Â 
Â  Â  function cargarUsuarios() {
Â  Â  Â  Â  const listaEl = document.getElementById("listaUsuarios");
Â  Â  Â  Â  listaEl.innerHTML = '<li>Cargando...</li>';
Â  Â  Â  Â  db.ref('users').once('value').then(snapshot => {
Â  Â  Â  Â  Â  Â  if (!snapshot.exists()) { listaEl.innerHTML = '<li>No hay usuarios registrados.</li>'; return; }
Â  Â  Â  Â  Â  Â  let html = '';
Â  Â  Â  Â  Â  Â  snapshot.forEach(userSnapshot => {
Â  Â  Â  Â  Â  Â  Â  Â  const user = userSnapshot.val();
Â  Â  Â  Â  Â  Â  Â  Â  html += `<li class="tarima-item"><div><b>${user.nombre}</b> (${user.rol})<br><small>Gafete: ${userSnapshot.key}</small></div></li>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  listaEl.innerHTML = html;
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function guardarUsuario() {
Â  Â  Â  Â  const gafete = document.getElementById('adminGafeteInput').value.trim();
Â  Â  Â  Â  const nombre = document.getElementById('adminNombreInput').value.trim();
Â  Â  Â  Â  if (!gafete || !nombre) { updateStatus('âŒ Complete todos los campos.', 'error'); return; }
Â  Â  Â  Â  db.ref('users/' + gafete).set({ nombre: nombre, rol: document.getElementById('adminRolSelect').value }).then(() => {
Â  Â  Â  Â  Â  Â  updateStatus('âœ… Usuario guardado.', 'success');
Â  Â  Â  Â  Â  Â  document.getElementById('adminGafeteInput').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('adminNombreInput').value = '';
Â  Â  Â  Â  Â  Â  cargarUsuarios();
Â  Â  Â  Â  }).catch(err => updateStatus('âŒ Error al guardar.', 'error'));
Â  Â  }

Â  Â  function eliminarUsuario(gafete) {
Â  Â  Â  Â  if (gafete === empleadoActual.id) { mostrarModal('alert', 'AcciÃ³n no permitida', 'No puedes eliminarte a ti mismo.'); return; }
Â  Â  Â  Â  mostrarModal('confirm', 'Confirmar', `Â¿Eliminar al usuario con gafete ${gafete}?`, (confirmed) => {
Â  Â  Â  Â  Â  Â  if (confirmed) {
Â  Â  Â  Â  Â  Â  Â  Â  db.ref('users/' + gafete).remove().then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateStatus('âœ… Usuario eliminado.', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cargarUsuarios();
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  function cargarConfiguracion() {
Â  Â  Â  Â  db.ref('configuracion').once('value').then(snapshot => {
Â  Â  Â  Â  Â  Â  if (snapshot.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  appConfig = snapshot.val();
Â  Â  Â  Â  Â  Â  Â  Â  if(document.getElementById('paramContrasena')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('paramContrasena').value = appConfig.contrasenaTarimas || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('paramCantidades').value = appConfig.cantidadesPiezas || '';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function guardarConfiguracion() {
Â  Â  Â  Â  const contrasena = document.getElementById('paramContrasena').value.trim();
Â  Â  Â  Â  const cantidades = document.getElementById('paramCantidades').value.trim();
Â  Â  Â  Â  if (!contrasena || !cantidades) { updateStatus('âŒ Ambos campos son requeridos.', 'error'); return; }
Â  Â  Â  Â  db.ref('configuracion').set({ contrasenaTarimas: contrasena, cantidadesPiezas: cantidades }).then(() => {
Â  Â  Â  Â  Â  Â  appConfig.contrasenaTarimas = contrasena; appConfig.cantidadesPiezas = cantidades;
Â  Â  Â  Â  Â  Â  updateStatus('âœ… ParÃ¡metros guardados.', 'success');
Â  Â  Â  Â  Â  Â  mostrarModal('alert', 'Ã‰xito', 'Los parÃ¡metros han sido actualizados.');
Â  Â  Â  Â  }).catch(err => updateStatus('âŒ Error al guardar.', 'error'));
Â  Â  }

    // --- (INICIO) NUEVO MÃ“DULO DE CONFIRMACIÃ“N DE TARIMAS ---

    function mostrarPantallaConfirmacion() {
        document.getElementById("pantallaPrincipal").innerHTML = `
            <p class="brand-title">CORNING</p>
            <div class="card">
                <h2>âœ… Registrar Tarima Confirmada</h2>
                <h4>Hola, <b>${empleadoActual.nombre}</b></h4>
                <p>Escanee el cÃ³digo de la tarima (BX) para confirmarla.</p>
                <div id="statusMessage"></div>
                <input type="text" id="tarimaConfirmadaInput" placeholder="Escanear Tarima (BX...)">
                ${isMobile ? `<button id="btnEscConfirmar" class="btn-primary">ğŸ“· Escanear Tarima</button>` : ""}
                <hr>
                <h4>Confirmadas Hoy (por ti):</h4>
                <ul id="listaConfirmadasHoy" style="max-height: 200px; overflow-y: auto; padding: 0;"></ul>
                <button onclick="cerrarSesion()" class="btn-danger">âŒ Salir</button>
            </div>`;
        
        updateStatus("Esperando escaneo de tarima...", 'info');
        
        const input = document.getElementById("tarimaConfirmadaInput");
        input.addEventListener("keypress", e => { 
            if (e.key === "Enter") procesarConfirmacion(e.target.value.trim()); 
        });
        
        if (isMobile) {
            document.getElementById("btnEscConfirmar").addEventListener("click", () => iniciarEscaneo("tarima-confirmacion"));
        }
        
        cargarConfirmadasHoy();
    }

    function procesarConfirmacion(codigoTarima) {
        const input = document.getElementById("tarimaConfirmadaInput");
        
        // ValidaciÃ³n (case-insensitive) tal como la pediste
        if (!codigoTarima.toUpperCase().startsWith('BX')) {
            updateStatus("âŒ Error: El cÃ³digo debe empezar con 'BX'.", 'error');
            if (input) input.value = "";
            return;
        }
        
        updateStatus("Procesando...", 'info');
        
        const data = {
            tarimaId: codigoTarima,
            usuario: {
                id: empleadoActual.id,
                nombre: empleadoActual.nombre
            },
            fechaHora: new Date().toISOString()
        };

        // Guardar en la nueva "colecciÃ³n" (ruta) de RTDB
        db.ref('tarimas_confirmadas').push().set(data).then(() => {
            updateStatus(`âœ… Tarima ${codigoTarima} confirmada.`, 'success');
            if (input) input.value = "";
            cargarConfirmadasHoy(); // Refresh the list
        }).catch(err => {
            updateStatus('âŒ Error al guardar. Intente de nuevo.', 'error');
        });
    }

    function cargarConfirmadasHoy() {
        const listaEl = document.getElementById("listaConfirmadasHoy");
        if (!listaEl) return;
        
        listaEl.innerHTML = '<li>Cargando...</li>';
        
        db.ref('tarimas_confirmadas')
          .orderByChild('usuario/id')
          .equalTo(empleadoActual.id)
          .limitToLast(20) // Obtener las Ãºltimas 20 de este usuario
          .once('value')
          .then(snapshot => {
            if (!snapshot.exists()) {
                listaEl.innerHTML = '<li style="background:none; padding: 10px; text-align: center; color: #ccc;">AÃºn no has confirmado tarimas hoy.</li>';
                return;
            }
            
            let html = '';
            let items = [];
            snapshot.forEach(child => {
                items.push(child.val());
            });

            // Ordenar por fecha descendente
            items.reverse(); 
            
            items.forEach(item => {
                html += `
                    <li class="tarima-item">
                        <div class="tarima-item-header-simple" style="justify-content: space-between;">
                            <span>${item.tarimaId}</span>
                            <small>${formatoFechaHora(item.fechaHora)}</small>
                        </div>
                    </li>`;
            });
            listaEl.innerHTML = html;
          });
    }

    // --- (FIN) NUEVO MÃ“DULO DE CONFIRMACIÃ“N DE TARIMAS ---


Â  Â  // --- MÃ“DULO DE RECOLECCIÃ“N ---
Â  Â  function mostrarPantallaOpcionesRecoleccion() {
Â  Â  Â  Â  const adminButtons = `<button onclick="mostrarReportesYAnalisis()" class="btn-secondary">ğŸ“Š Reportes</button><button onclick="solicitarAccesoEdicion()" class="btn-secondary">ğŸ“ Editar Tarimas</button>`;
Â  Â  Â  Â  document.getElementById("pantallaPrincipal").innerHTML = `<p class="brand-title">CORNING</p><div class="card"><h2>ğŸ“¦ RecolecciÃ³n</h2><h3>Bienvenido, <b>${empleadoActual.nombre}</b></h3><h4>Resumen del Turno (${determinarTurno()})</h4><div id="resumenTurno" style="padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">Tarimas: <b id="tarimasRegistradas">0</b> | Cajas: <b id="cajasRegistradas">0</b></div><button onclick="crearNuevaTarima()" class="btn-green">ğŸ“¦ Crear Nueva Tarima</button><button onclick="mostrarEdicionTarimasPropias()" class="btn-secondary">ğŸ“‹ Ver mis Tarimas</button>${empleadoActual.rol === 'administrador' ? adminButtons : ''}<button onclick="cerrarSesion()" class="btn-danger">âŒ Cerrar sesiÃ³n</button></div>`;
Â  Â  Â  Â  actualizarResumenTurno();
Â  Â  }
Â  Â Â 
Â  Â  function actualizarResumenTurno() {
Â  Â  Â  Â  db.ref("tarimas").orderByChild("empleadoId").equalTo(empleadoActual.id).once("value").then(snapshot => {
Â  Â  Â  Â  Â  Â  let tarimasCount = 0, cajasCount = 0;
Â  Â  Â  Â  Â  Â  const fechaTurnoActual = obtenerFechaTurno();
Â  Â  Â  Â  Â  Â  const turnoActual = determinarTurno();
Â  Â  Â  Â  Â  Â  snapshot.forEach(tarimaSnapshot => {
Â  Â  Â  Â  Â  Â  Â  Â  const tarima = tarimaSnapshot.val();
Â   Â  Â  Â  Â  Â  Â  if (obtenerFechaTurno(tarima.fechaCreacion) === fechaTurnoActual && tarima.turno === turnoActual) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tarimasCount++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (tarima.cajas) cajasCount += Object.keys(tarima.cajas).length;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const tarimasEl = document.getElementById("tarimasRegistradas"), cajasEl = document.getElementById("cajasRegistradas");
Â  Â  Â  Â  Â  Â  if (tarimasEl && cajasEl) { tarimasEl.textContent = tarimasCount; cajasEl.textContent = cajasCount; }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function crearNuevaTarima() { db.ref("tarimas").orderByKey().limitToLast(1).once("value").then(s => { let n=1; if(s.exists()){const i=parseInt(Object.keys(s.val())[0].split('-')[1]);if(!isNaN(i))n=i+1} const id="TAR-"+String(n).padStart(3,'0'); currentTarima=id; cantidadPiezasActual=null; db.ref("tarimas/"+id).set({id,empleadoId:empleadoActual.id,fechaCreacion:new Date().toISOString(),turno:determinarTurno(),cajas:{},estado:'pendiente'}).then(()=>mostrarFormularioTarima(id))})}
Â  Â  function mostrarFormularioTarima(id){document.getElementById("pantallaPrincipal").innerHTML=`<p class="brand-title">CORNING</p><div class="card"><h3>Tarima: ${id}</h3><h4>Cantidad actual: <span id="cantidadActual">${cantidadPiezasActual||'Sin seleccionar'}</span></h4><div id="statusMessage"></div><input type="text" id="codigoCaja" placeholder="Escanear Cantidad o CÃ³digo BX">${isMobile?`<button id="btnEscCaja" class="btn-primary">ğŸ“· Escanear</button>`:""}<h4>Resumen</h4><div id="resumenTarima" style="padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;">Cajas: 0 | Piezas: 0</div><h4>Cajas Registradas</h4><ul id="listaCajas"></ul><button onclick="terminarRegistroTarima('${id}')" class="btn-orange">âœ… Terminar</button><button onclick="cancelarCreacionTarima('${id}')" class="btn-danger">âŒ Cancelar</button></div>`;updateStatus(`Escanee un cÃ³digo de cantidad (${appConfig.cantidadesPiezas}) para empezar.`,'info');if(isMobile)document.getElementById("btnEscCaja").addEventListener("click",()=>iniciarEscaneo("caja"));document.getElementById("codigoCaja").addEventListener("keypress",e=>{if(e.key==="Enter")procesarEscaneo(e.target.value.trim(),id)});actualizarResumenTarima(id)}
Â  Â  function procesarEscaneo(v,id){const i=document.getElementById("codigoCaja"),c=appConfig.cantidadesPiezas.split(',').map(Number),p=parseInt(v);if(c.includes(p)){cantidadPiezasActual=p;document.getElementById("cantidadActual").textContent=p;updateStatus(`âœ… Cantidad establecida a ${p}.`,'success');i.value="";return}if(!v.toUpperCase().startsWith('BX')){updateStatus("âŒ El cÃ³digo debe empezar con 'BX'.",'error');i.value="";return}if(cantidadPiezasActual===null){updateStatus(`âŒ Primero escanee la cantidad (${appConfig.cantidadesPiezas}).`,'error');i.value="";return}const b=v.trim();db.ref("tarimas").once("value").then(s=>{let e=!1,t=null;s.forEach(a=>{if(a.val().cajas&&Object.values(a.val().cajas).find(c=>c.codigoCaja===b)){e=!0;t=a.key}});if(e){updateStatus(`âŒ BX ya agregado a la tarima: ${t}`,'error');i.value="";return}const d={codigoCaja:b,numeroOrden:b.substring(2,12),cantidadPiezas:cantidadPiezasActual,empleadoId:empleadoActual.id,turno:determinarTurno(),timestamp:new Date().toISOString()};db.ref(`tarimas/${id}/cajas`).push().set(d).then(()=>{updateStatus(`ğŸ“¦ Caja ${b} guardada.`,'success');actualizarResumenTarima(id)})});i.value=""}
Â  Â Â 
Â  Â  function actualizarResumenTarima(idTarima) {
Â  Â  Â  Â  db.ref(`tarimas/${idTarima}/cajas`).once("value").then(snapshot => {
Â  Â  Â  Â  Â  Â  const cajas = snapshot.val() || {};
Â  Â  Â  Â  Â  Â  const totalCajas = Object.keys(cajas).length;
Â  Â  Â  Â  Â  Â  let totalPiezas = 0;
Â  Â  Â  Â  Â  Â  let listaHtml = "";
Â  Â  Â  Â  Â  Â  const cajasPorOrden = {};

Â  Â  Â  Â  Â  Â  snapshot.forEach(cajaSnapshot => {
Â  Â  Â  Â  Â  Â  Â  Â  const caja = cajaSnapshot.val();
Â  Â  Â  Â  Â  Â  Â  Â  totalPiezas += caja.cantidadPiezas || 0;
Â  Â  Â  Â  Â  Â  Â  Â  if (!cajasPorOrden[caja.numeroOrden]) cajasPorOrden[caja.numeroOrden] = [];
Â  Â  Â  Â  Â  Â  Â  Â  cajasPorOrden[caja.numeroOrden].push({ id: cajaSnapshot.key, ...caja });
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  for (const orden in cajasPorOrden) {
Â  Â  Â  Â  Â  Â  Â  Â  const totalPiezasOrden = cajasPorOrden[orden].reduce((sum, c) => sum + c.cantidadPiezas, 0);
Â  Â  Â  Â  Â  Â  Â  Â  const cajasHtml = cajasPorOrden[orden].map(c => `<li>${c.codigoCaja} <button onclick="event.stopPropagation(); eliminarCaja('${idTarima}', '${c.id}')" class="btn-danger list-item-btn">ğŸ—‘ï¸</button></li>`).join('');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  listaHtml += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li class="tarima-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="tarima-item-header" onclick="toggleDetalles('cajas-orden-${orden}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>Orden: ${orden} | Piezas: ${totalPiezasOrden}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-secondary list-item-btn">Ver Cajas</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="cajas-desplegables" id="cajas-orden-${orden}" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${cajasHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </li>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const resumenEl = document.getElementById("resumenTarima");
Â  Â  Â  Â  Â  Â  const listaEl = document.getElementById("listaCajas");
Â  Â  Â  Â  Â  Â  if (resumenEl && listaEl) {
Â  Â  Â  Â  Â  Â  Â  Â  resumenEl.innerText = `Cajas: ${totalCajas} | Piezas: ${totalPiezas}`;
Â  Â  Â  Â  Â  Â  Â  Â  listaEl.innerHTML = listaHtml;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  actualizarResumenTurno();
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function eliminarCaja(idTarima, idCaja) {
Â  Â  Â  Â  mostrarModal('confirm', 'Confirmar', 'Â¿Eliminar esta caja?', (confirmed) => {
Â  Â  Â  Â  Â  Â  if (confirmed) {
Â  Â  Â  Â  Â  Â  Â  Â  db.ref(`tarimas/${idTarima}/cajas/${idCaja}`).remove().then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateStatus("Caja eliminada.", 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actualizarResumenTarima(idTarima);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  function terminarRegistroTarima(idTarima) {
Â  Â  Â  Â  mostrarPantallaOpcionesRecoleccion();
Â  Â  Â  Â  db.ref(`tarimas/${idTarima}/cajas`).once("value").then(snapshot => {
Â  Â  Â  Â  Â  Â  const cajas = snapshot.val();
Â  Â  Â  Â  Â  Â  const totalCajas = cajas ? Object.keys(cajas).length : 0;
Â  Â  Â  Â  Â  Â  const cajasAInspeccionar = Math.ceil(totalCajas * 0.20);
Â  Â  Â  Â  Â  Â  const mensaje = `<div style="text-align: left; line-height: 1.6;">ID de Tarima: <b>${idTarima}</b><br>Total de cajas: <b>${totalCajas}</b></div><hr style="border-color: rgba(255,255,255,0.2); margin: 15px 0;"><div style="font-size: 1.1em; font-weight: bold; color: #F59E0B;">CAJAS A INSPECCIONAR:<div style="font-size: 1.8em; margin-top: 5px;">${cajasAInspeccionar}</div></div>`;
Â  Â  Â  Â  Â  Â  mostrarModal('alert', 'âœ… Registro Finalizado', mensaje);
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function cancelarCreacionTarima(id){mostrarModal('confirm','Confirmar','Â¿Cancelar y eliminar esta tarima?',c=>{if(c)db.ref(`tarimas/${id}`).remove().then(mostrarPantallaOpcionesRecoleccion)})}

Â  Â  // --- EDICIÃ“N Y GESTIÃ“N DE TARIMAS (con UI limpia y desplegable) ---
Â  Â  function solicitarAccesoEdicion() {
Â  Â  Â  Â  mostrarModal('prompt', 'Acceso de Administrador', 'Ingrese la contraseÃ±a:', (password) => {
Â  Â  Â  Â  Â  Â  if (password === appConfig.contrasenaTarimas) mostrarEdicionTarimasAdmin();
Â  Â  Â  Â  Â  Â  else if (password !== null) mostrarModal('alert', 'Acceso Denegado', 'ContraseÃ±a incorrecta.');

Â  Â  Â  Â  });
Â  Â  }

Â  Â  function mostrarEdicionTarimasPropias() {
Â  Â  Â  Â  document.getElementById("pantallaPrincipal").innerHTML = `<p class="brand-title">CORNING</p><div class="card"><h2>ğŸ“ Mis Tarimas Creadas</h2><p><small>Haz clic en una tarima para ver sus detalles.</small></p><button onclick="mostrarPantallaOpcionesRecoleccion()" class="btn-primary">â¬…ï¸ Regresar</button><div id="statusMessage"></div><ul id="listaEdicionTarimas"></ul></div>`;
Â  Â  Â  Â  cargarListaEdicionTarimas(true);
Â  Â  }

Â  Â  function mostrarEdicionTarimasAdmin() {
Â  Â  Â  Â  document.getElementById("pantallaPrincipal").innerHTML = `<p class="brand-title">CORNING</p><div class="card" style="max-width: 800px;"><h2>ğŸ“ Editar/Eliminar Todas las Tarimas</h2><p><small>Haz clic en una tarima para ver sus detalles.</small></p><button onclick="mostrarPantallaOpcionesRecoleccion()" class="btn-primary">â¬…ï¸ Regresar</button><div id="statusMessage"></div><ul id="listaEdicionTarimas"></ul></div>`;
Â  Â  Â  Â  cargarListaEdicionTarimas(false);
Â  Â  }
Â  Â Â 
Â  Â  async function cargarListaEdicionTarimas(soloPropias) {
Â  Â  Â  Â  updateStatus("Cargando tarimas...", 'info');
Â  Â  Â  Â  const query = soloPropias ? db.ref("tarimas").orderByChild("empleadoId").equalTo(empleadoActual.id) : db.ref("tarimas");
Â  Â  Â  Â  const logsSnapshot = await db.ref('historialLogs').once('value');
Â  Â  Â  Â  const logsPorTarima = clasificarLogsPorTarima(logsSnapshot.val());

Â  Â  Â  Â  const snapshot = await query.once('value');
Â  Â  Â  Â  let lista = "";
Â  Â  Â  Â  if (!snapshot.exists()) {
Â  Â  Â  Â  Â  Â  lista = `<li class="tarima-item">No se encontraron tarimas.</li>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const tarimasArray = [];
Â  Â  Â  Â  Â  Â  snapshot.forEach(tarimaSnapshot => { tarimasArray.push(tarimaSnapshot.val()); });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  tarimasArray.reverse().forEach(tarima => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!tarima.id) return;
Â  Â  Â  Â  Â  Â  Â  Â  const cajasHtml = Object.values(tarima.cajas || {}).map(caja => `<li>${caja.codigoCaja} (${caja.cantidadPiezas} pz)</li>`).join('');
Â  Â  Â  Â  Â  Â  Â  Â  const detallesHtml = `<p style="margin: 0;"><b>Fecha:</b> ${formatoFechaHora(tarima.fechaCreacion)} | <b>Creada por:</b> ${tarima.empleadoId}</p>${determinarEstadoCompleto(tarima, logsPorTarima[tarima.id] || [])}<div class="cajas-desplegables"><h4>Contenido (BX):</h4><ul>${cajasHtml || '<li>No hay cajas registradas.</li>'}</ul></div><div class="edit-delete-btns"><button onclick="editarTarima('${tarima.id}')" class="btn-primary">âœï¸ Editar</button><button onclick="eliminarTarima('${tarima.id}', ${soloPropias})" class="btn-danger">ğŸ—‘ï¸ Eliminar</button></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  lista += `<li class="tarima-item" onclick="toggleDetalles('detalles-${tarima.id}')"><div class="tarima-item-header-simple">Tarima: ${tarima.id}</div><div class="tarima-detalles-desplegables" id="detalles-${tarima.id}" style="display:none;">${detallesHtml}</div></li>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  document.getElementById("listaEdicionTarimas").innerHTML = lista;
Â  Â  Â  Â  updateStatus("Lista cargada.", 'success');
Â  Â  }

Â  Â  function clasificarLogsPorTarima(logsPorFecha) {
Â  Â  Â  Â  const resultado = {};
Â  Â  Â  Â  if (!logsPorFecha) return resultado;
Â  Â  Â  Â  Object.values(logsPorFecha).forEach(logsPorTurno => {
Â  Â  Â  Â  Â  Â  Object.values(logsPorTurno).forEach(logs => {
Â  Â  Â  Â  Â  Â  Â  Â  Object.values(logs).forEach(log => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (log.tarimaId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!resultado[log.tarimaId]) resultado[log.tarimaId] = [];
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resultado[log.tarimaId].push(log);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  Â  return resultado;
Â  Â  }

Â  Â  function determinarEstadoCompleto(tarima, logs) {
Â  Â  Â  Â  const recolectada = logs.find(log => log.accion === 'recolectada');
Â  Â  Â  Â  const confirmadaProd = logs.find(log => log.accion === 'confirmada_en_produccion');
Â  Â  Â  Â  let statusText = "Pendiente de Calidad â³";
Â  Â  Â  Â  if (recolectada) statusText = "Recolectada (LogÃ­stica) ğŸš›";
Â  Â  Â  Â  else if (confirmadaProd) statusText = "En Proceso (ProducciÃ³n) âš™ï¸";
Â  Â  Â  Â  else if (tarima.estado === 'liberada') statusText = "Liberada (Calidad) âœ…";
Â  Â  Â  Â  else if (tarima.estado === 'rechazada') statusText = `Rechazada (Calidad) âŒ`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const tsCalidad = tarima.timestampLiberada || tarima.timestampRechazo;
Â  Â  Â  Â  const tsProd = confirmadaProd?.timestamp;
Â  Â  Â  Â  const tsLogistica = recolectada?.horaApagado;

Â  Â  Â  Â  const timestampsItems = [];
Â  Â  Â  Â  if(tsCalidad) timestampsItems.push(`<li><small>Calidad: ${formatoFechaHora(tsCalidad)}</small></li>`);
Â  Â  Â  Â  if(tsProd) timestampsItems.push(`<li><small>ProducciÃ³n: ${formatoFechaHora(tsProd)}</small></li>`);
Â  Â  Â  Â  if(tsLogistica) timestampsItems.push(`<li><small>LogÃ­stica: ${formatoFechaHora(tsLogistica)}</small></li>`);
Â  Â  Â  Â Â 
Â  Â  Â  Â  let timestampsHtml = '';
Â  Â  Â  Â  if (timestampsItems.length > 0) {
Â  Â  Â  Â  Â  Â  timestampsHtml = `<div class="workflow-timestamps"><b>Trazabilidad:</b><ul>${timestampsItems.join('')}</ul></div>`;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  return `<div class="workflow-status"><b>Estado:</b> ${statusText}</div>${timestampsHtml}`;
Â  Â  }

Â  Â  function editarTarima(idTarima) {
Â  Â  Â  Â  event.stopPropagation(); currentTarima = idTarima; mostrarFormularioTarima(idTarima);
Â  Â  Â  Â  updateStatus(`Editando tarima ${idTarima}`, 'info');
Â  Â  }

Â  Â  function eliminarTarima(idTarima, soloPropias) {
Â  Â  Â  Â  event.stopPropagation();
Â  Â  Â  Â  mostrarModal('confirm', 'Confirmar', `Â¿Eliminar la tarima ${idTarima}?`, (confirmed) => {
Â  Â  Â  Â  Â  Â  if (confirmed) db.ref(`tarimas/${idTarima}`).remove().then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  mostrarModal('alert', 'Eliminada', `La tarima ${idTarima} ha sido eliminada.`);
 Â  Â  Â  Â  Â  Â  if (soloPropias) mostrarEdicionTarimasPropias(); else mostrarEdicionTarimasAdmin();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // --- MÃ“DULO DE VERIFICACIÃ“N Y REPORTES (tambiÃ©n adoptan la nueva UI) ---
Â  Â  async function buscarYMostrarInfoBX(codigoCaja) {
Â  Â  Â  Â  if (!codigoCaja.toUpperCase().startsWith('BX')) { updateStatus("âŒ El cÃ³digo debe empezar con 'BX'.", 'error'); return; }
Â  Â  Â  Â  const tarimasSnapshot = await db.ref("tarimas").once("value");
Â  Â  Â  Â  let tarimaEncontrada = null;
Â  Â  Â  Â  tarimasSnapshot.forEach(ts=>{if(ts.val().cajas&&Object.values(ts.val().cajas).find(c=>c.codigoCaja===codigoCaja))tarimaEncontrada=ts.val()});
Â  Â  Â  Â  if (!tarimaEncontrada) { updateStatus("âŒ Caja no encontrada.", 'error'); }Â 
Â  Â  Â  Â  else { const logsSnapshot=await db.ref('historialLogs').once('value'); const logsPorTarima=clasificarLogsPorTarima(logsSnapshot.val()); mostrarInfoTarima(tarimaEncontrada, codigoCaja, logsPorTarima); }
Â  Â  }
Â  Â  function mostrarInfoTarima(d,c,l){const h=Object.values(d.cajas||{}).map(a=>`<li ${a.codigoCaja===c?'style="background-color:rgba(0,122,255,0.5);"':''}>${a.codigoCaja}</li>`).join('');document.getElementById("pantallaPrincipal").innerHTML=`<p class="brand-title">CORNING</p><div class="card"><h2>ğŸ” InformaciÃ³n de Tarima</h2><h3>Tarima: <b>${d.id}</b></h3><p><b>Recolector:</b> ${d.empleadoId}</p>${determinarEstadoCompleto(d,l[d.id]||[])}<hr><h4>Cajas (${Object.keys(d.cajas||{}).length}):</h4><ul id="listaInfoCajas" style="max-height:200px;overflow-y:auto;">${h}</ul><div id="statusMessage"></div><button onclick="iniciarFlujoVerificacion()" class="btn-secondary">ğŸ” Verificar otro BX</button><button onclick="mostrarPantallaInicio()" class="btn-primary">â¬…ï¸ Regresar</button></div>`;updateStatus(`InformaciÃ³n para el BX: ${c}`,'info')}
Â  Â  function iniciarFlujoVerificacion(){document.getElementById("pantallaPrincipal").innerHTML=`<p class="brand-title">CORNING</p><div class="card"><h2>ğŸ” VerificaciÃ³n de BX</h2><p>Escanee un cÃ³digo BX.</p><div id="statusMessage"></div><input type="text" id="verificacionInput" placeholder="Escanear BX-XXX">${isMobile?`<button id="btnEscVerificacion" class="btn-secondary">ğŸ“· Escanear</button>`:""}<button onclick="mostrarPantallaInicio()" class="btn-primary">â¬…ï¸ Regresar</button></div>`;updateStatus("Esperando escaneo...",'info');const i=document.getElementById("verificacionInput");i.addEventListener("keypress",e=>{if(e.key==="Enter")buscarYMostrarInfoBX(i.value.trim())});if(isMobile)document.getElementById("btnEscVerificacion").addEventListener("click",()=>iniciarEscaneo("verificacion"))}

Â  Â  function mostrarReportesYAnalisis(){const h=new Date().toISOString().slice(0,10);document.getElementById("pantallaPrincipal").innerHTML=`<p class="brand-title">CORNING</p><div class="card" style="max-width:900px;"><h2>ğŸ“Š Reportes</h2><p><small>Haz clic en una tarima para ver sus detalles.</small></p><div class="report-filters"><input type="date" id="filtroFechaInicio" value="${h}"><input type="date" id="filtroFechaFin" value="${h}"><input type="text" id="filtroEmpleado" placeholder="ID Empleado (opcional)"><select id="filtroEstado"><option value="todos">Todos los estados</option><option value="Pendiente de Calidad â³">Pendiente</option><option value="Liberada (Calidad) âœ…">Liberada</option><option value="En Proceso (ProducciÃ³n) âš™ï¸">En ProducciÃ³n</option><option value="Recolectada (LogÃ­stica) ğŸš›">Recolectada</option><option value="Rechazada (Calidad) âŒ">Rechazada</option></select></div><button onclick="generarReporte()" class="btn-primary">ğŸ” Generar Reporte</button><button onclick="mostrarPantallaOpcionesRecoleccion()" class="btn-secondary">â¬…ï¸ Regresar</button><div id="statusMessage"></div><div id="reporteResultados" class="report-section"><hr><h4>Resultados</h4><div id="reporteResumen"></div><ul id="listaResultadosReporte"></ul></div></div>`}
Â  Â  async function generarReporte(){updateStatus("Generando reporte...",'info');const fI=document.getElementById("filtroFechaInicio").value,fF=document.getElementById("filtroFechaFin").value,eI=document.getElementById("filtroEmpleado").value.trim(),eF=document.getElementById("filtroEstado").value;const tS=await db.ref("tarimas").orderByChild('fechaCreacion').startAt(new Date(fI).toISOString()).endAt(new Date(fF+"T23:59:59").toISOString()).once("value"),lS=await db.ref('historialLogs').once('value'),lPT=clasificarLogsPorTarima(lS.val());let r=[];tS.forEach(t=>{const a=t.val();if(!a.id)return;const eC=determinarEstadoCompleto(a,lPT[a.id]||[]),eST=eC.match(/<b>Estado:<\/b> (.*?)<\/div>/)[1];const cF=(eI===''||a.empleadoId===eI)&&(eF==='todos'||eST===eF);if(cF)r.push({...a,estadoCompletoHTML:eC,estadoFiltro:eST})});mostrarResultadosReporte(r.reverse())}
Â  Â  function mostrarResultadosReporte(r){const lR=document.getElementById("listaResultadosReporte"),rD=document.getElementById("reporteResumen");if(r.length===0){lR.innerHTML=`<li class="tarima-item">No se encontraron resultados.</li>`;rD.innerHTML='';updateStatus("Reporte generado. 0 resultados.",'info');return}let h="",tC=0,cE={};r.forEach(t=>{const n=t.cajas?Object.keys(t.cajas).length:0;tC+=n;cE[t.estadoFiltro]=(cE[t.estadoFiltro]||0)+1;const c=Object.values(t.cajas||{}).map(a=>`<li>${a.codigoCaja} (${a.cantidadPiezas} pz)</li>`).join('');h+=`<li class="tarima-item" onclick="toggleDetalles('detalles-reporte-${t.id}')"><div class="tarima-item-header-simple">Tarima: ${t.id}</div><div class="tarima-detalles-desplegables" id="detalles-reporte-${t.id}" style="display:none;"><p style="margin:0;"><b>Fecha:</b> ${formatoFechaHora(t.fechaCreacion)} | <b>Creada por:</b> ${t.empleadoId}</p>${t.estadoCompletoHTML}<div class="cajas-desplegables"><h4>Contenido (BX):</h4><ul>${c||'<li>No hay cajas.</li>'}</ul></div></div></li>`});let rH=Object.entries(cE).map(([e,c])=>`<div class="resumen-item">${e}: <b>${c}</b></div>`).join('');rD.innerHTML=`<p style="width:100%;text-align:center;"><b>Resultados: ${r.length} tarimas | ${tC} cajas</b></p>${rH}`;lR.innerHTML=h;updateStatus(`Reporte generado con ${r.length} resultados.`,'success')}

Â  Â  // --- FUNCIONALIDAD DEL ESCÃNER Y ARRANQUE ---
Â  Â  async function iniciarEscaneo(tipo) {
Â  Â  Â  Â  if (scanning) return;
Â  Â  Â  Â  modo = tipo; scanning = true;
Â  Â  Â  Â  document.getElementById('scannerModal').classList.add('active');
Â  Â  Â  Â  codeReader = new ZXing.BrowserBarcodeReader();
Â  Â  Â  Â  updateStatus("CÃ¡mara activa...", 'info');
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const result = await codeReader.decodeOnceFromVideoDevice(undefined, 'preview');
Â  Â  Â  Â  Â  Â  detenerCamara();
Â  Â  Â  Â  Â  Â  const valor = result.text.trim();
Â  Â  Â  Â  Â  Â  if (modo.startsWith("gafete-")) verificarAcceso(valor, modo.split('-')[1]);
Â  Â  Â  Â  Â  Â  else if (modo === "caja") procesarEscaneo(valor, currentTarima);
Â  Â  Â  Â  Â  Â  else if (modo === "verificacion") buscarYMostrarInfoBX(valor);
            else if (modo === "tarima-confirmacion") procesarConfirmacion(valor);
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  updateStatus("âŒ No se pudo leer el cÃ³digo.", 'error');
Â  Â  Â  Â  Â  Â  detenerCamara();
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function detenerCamara() {
Â  Â  Â  Â  if (codeReader) codeReader.reset();
 Â  Â  Â  document.getElementById('scannerModal').classList.remove('active');
Â  Â  Â  Â  scanning = false;
Â  Â  }

Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  const splash = document.getElementById('splashScreen');
Â  Â  Â  Â  const main = document.getElementById('pantallaPrincipal');
Â  Â  Â  Â Â 
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  splash.style.opacity = '0';
            
            /* --- ERROR 'g' CORREGIDO AQUÃ --- */
            /* Se eliminÃ³ la 'g' que rompÃ­a el JS */
Â  Â  Â  Â  Â  Â  splash.addEventListener('transitionend', () => {
Â  Â  Â  Â  Â  Â  Â  Â  splash.classList.remove('activa');
Â  Â  Â  Â  Â  Â  Â  Â  activarPantalla('pantallaPrincipal');
Â  Â  Â  Â  Â  Â  Â  Â  mostrarPantallaInicio();
Â  Â  Â  Â  Â  Â  }, { once: true });
Â  Â  Â  Â  }, 2000);

Â  Â  Â  Â  cargarConfiguracion();
Â  Â  Â  Â  document.getElementById('closeScannerBtn').addEventListener('click', detenerCamara);

Â  Â  Â  Â  /* --- BLOQUE DE SERVICE WORKER ELIMINADO --- */

Â  Â  });

</script>
</body>
</html>