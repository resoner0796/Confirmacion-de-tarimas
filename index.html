<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Tarimas Confirmadas - CORNING</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
  color: #FFFFFF;
  margin: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  flex-direction: column;
}
.brand-title {
  font-family: 'Times New Roman', Times, serif;
  font-size: 42px;
  color: white;
  margin: 0 auto 10px auto;
  text-align: center;
}
.card {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  padding: 25px;
  border-radius: 20px;
  text-align: center;
  width: 90%;
  max-width: 600px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}
input, select {
  width: calc(100% - 20px);
  padding: 10px;
  margin: 8px 0;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(255,255,255,0.15);
  color: #fff;
}
button {
  width: 100%;
  padding: 15px;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  margin-top: 10px;
  font-weight: bold;
  color: #fff;
  transition: transform 0.1s ease, background 0.2s ease;
}
button:hover { transform: scale(1.02); }
.btn-primary { background-color: rgba(0,122,255,0.6); }
.btn-green { background-color: rgba(76,175,80,0.6); }
.btn-danger { background-color: rgba(255,59,48,0.6); }
.btn-orange { background-color: rgba(255,193,7,0.7); color: #000; }
.btn-blue { background-color: rgba(0, 150, 255,0.6); }
#statusMessage { margin-top: 10px; font-weight: bold; min-height: 20px; text-align:center; }
ul { list-style: none; padding: 0; text-align: left; }
li { background: rgba(255,255,255,0.1); margin-bottom: 6px; padding: 8px; border-radius: 8px; transition: all 0.4s ease; }
.user-actions { display: flex; gap: 5px; margin-top: 5px; }
.tarimaBox { background: rgba(255,255,255,0.12); border-radius: 10px; padding: 12px; margin: 5px 0; box-shadow:0 4px 12px rgba(0,0,0,0.2);}
#modalContainer {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.65);
  justify-content:center;
  align-items:center;
  z-index:1000;
}
#modalContent {
  background: rgba(255,255,255,0.05);
  backdrop-filter: blur(12px);
  border-radius: 16px;
  max-width:600px;
  width:90%;
  color:#fff;
  padding:25px;
  position:relative;
  max-height:90vh;
  overflow-y:auto;
  box-shadow: 0 12px 32px rgba(0,0,0,0.4);
}
#modalClose {
  position:absolute;
  top:12px;
  right:18px;
  cursor:pointer;
  font-weight:bold;
  font-size:18px;
}
details summary { cursor:pointer; font-weight:bold; }
#scanFeedback { text-align:center; margin-bottom:8px; font-weight:bold; min-height:20px; }
.newScan { background: rgba(76,175,80,0.6); border-radius:6px; transition: all 0.5s; animation: highlight 0.6s ease; }
@keyframes highlight {
  0% { transform: scale(1); background: rgba(76,175,80,0.4);}
  50% { transform: scale(1.05); background: rgba(76,175,80,0.9);}
  100% { transform: scale(1); background: rgba(76,175,80,0.6);}
}
#counter { font-weight:bold; margin-top:5px; display:inline-block; transition: all 0.4s ease; }
.counterFlash { animation: flashCounter 0.5s ease; }
@keyframes flashCounter {
  0% { transform: scale(1); color:#fff;}
  50% { transform: scale(1.2); color:#4CAF50;}
  100% { transform: scale(1); color:#fff;}
}
</style>
</head>
<body>
<div id="app"></div>

<div id="modalContainer">
  <div id="modalContent">
    <span id="modalClose">‚úñÔ∏è</span>
    <div id="modalBody"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, setDoc, doc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDtlj3ppT9WBGMR60SZx0TZmAo3BXQWDX0",
  authDomain: "rastreador-de-ordenes.firebaseapp.com",
  projectId: "rastreador-de-ordenes",
  storageBucket: "rastreador-de-ordenes.firebasestorage.app",
  messagingSenderId: "956052823395",
  appId: "1:956052823395:web:ca6127628e1dcf423cc756"
};
const appFB = initializeApp(firebaseConfig);
const db = getFirestore(appFB);

const SUPER_ADMIN_GAFETE = "528734";
let usuarioActual = null;
let tarimaActual = null;
let cajasTarima = [];
const appDiv = document.getElementById('app');

function abrirModal(html){
  document.getElementById('modalBody').innerHTML = html;
  document.getElementById('modalContainer').style.display = 'flex';
}
document.getElementById('modalClose').onclick = ()=>{ document.getElementById('modalContainer').style.display='none'; }

function updateStatus(msg,type='info'){
  const el=document.getElementById('statusMessage');
  if(!el) return;
  el.textContent=msg;
  if(type==='success') el.style.color='#4CAF50';
  else if(type==='error') el.style.color='#FF5252';
  else el.style.color='#9CA3AF';
}
function setView(html){ appDiv.innerHTML=html; }

function mostrarLogin(){
  setView(`
    <p class="brand-title">CORNING</p>
    <div class="card">
      <h2>üîê Iniciar Sesi√≥n</h2>
      <p>Escanea o ingresa tu n√∫mero de gafete:</p>
      <input id="gafeteInput" type="text" placeholder="N√∫mero de gafete">
      <button id="btnLogin" class="btn-primary">Ingresar</button>
      <div id="statusMessage"></div>
    </div>
  `);
  document.getElementById('btnLogin').onclick = verificarGafete;
  document.getElementById('gafeteInput').addEventListener('keypress',e=>{ if(e.key==='Enter') verificarGafete(); });
}

async function verificarGafete(){
  const gafete = document.getElementById('gafeteInput').value.trim();
  if(!gafete){ updateStatus("Ingresa tu gafete",'error'); return; }
  try{
    const snapshot = await getDocs(collection(db,"users"));
    let userData=null;
    snapshot.forEach(docu=>{ const data=docu.data(); if(data.gafete===gafete) userData=data; });
    if(!userData && gafete!==SUPER_ADMIN_GAFETE){ updateStatus("‚ùå Usuario no encontrado.",'error'); return; }
    if(gafete===SUPER_ADMIN_GAFETE && !userData){
      userData={ nombre:"Super Admin", gafete, rol:"administrador" };
      await setDoc(doc(db,"users",gafete),userData);
    }
    usuarioActual=userData;
    updateStatus(`Bienvenido ${userData.nombre}`,'success');
    setTimeout(()=>{ 
      if(usuarioActual.rol==="administrador") mostrarAdministracion();
      else mostrarConfirmacionTarimas();
    },1000);
  }catch(e){ console.error(e); updateStatus("Error al conectar con Firestore",'error'); }
}

// --- ADMIN ---
function mostrarAdministracion(){
  setView(`
    <p class="brand-title">CORNING</p>
    <div class="card">
      <h2>‚öôÔ∏è Administraci√≥n</h2>
      <input id="nombreUsuario" placeholder="Nombre del empleado">
      <input id="gafeteUsuario" placeholder="N√∫mero de gafete">
      <select id="rolUsuario">
        <option value="empleado">Empleado</option>
        <option value="administrador">Administrador</option>
      </select>
      <button id="btnAgregar" class="btn-green">üíæ Agregar Usuario</button>
      <hr>
      <h4>Usuarios Registrados:</h4>
      <ul id="listaUsuarios"></ul>
      <hr>
      <button id="btnConsultarTarimas" class="btn-blue">üìã Consultar Tarimas Confirmadas</button>
      <button id="btnSalir" class="btn-danger">‚ùå Cerrar Sesi√≥n</button>
      <div id="statusMessage"></div>
    </div>
  `);
  document.getElementById('btnAgregar').onclick=agregarUsuario;
  document.getElementById('btnSalir').onclick=cerrarSesion;
  document.getElementById('btnConsultarTarimas').onclick=consultarTarimas;
  cargarUsuarios();
}

async function cargarUsuarios(){
  const lista=document.getElementById('listaUsuarios');
  lista.innerHTML='<li>Cargando...</li>';
  const snapshot=await getDocs(collection(db,"users"));
  let html='';
  snapshot.forEach(docu=>{
    const d=docu.data();
    html+=`<li>${d.nombre} (${d.rol}) - Gafete: ${d.gafete}
      <div class="user-actions">
        <button class="btn-green" onclick="editarUsuario('${docu.id}')">‚úèÔ∏è</button>
        <button class="btn-danger" onclick="eliminarUsuario('${docu.id}')">‚ùå</button>
      </div>
    </li>`;
  });
  lista.innerHTML=html||'<li>No hay usuarios registrados.</li>';
}

async function agregarUsuario(){
  const nombre=document.getElementById('nombreUsuario').value.trim();
  const gafete=document.getElementById('gafeteUsuario').value.trim();
  const rol=document.getElementById('rolUsuario').value;
  if(!nombre || !gafete){ updateStatus('‚ùå Completa todos los campos.','error'); return; }
  await setDoc(doc(db,"users",gafete),{ nombre, gafete, rol });
  updateStatus('‚úÖ Usuario agregado.','success');
  document.getElementById('nombreUsuario').value='';
  document.getElementById('gafeteUsuario').value='';
  cargarUsuarios();
}
window.eliminarUsuario=async function(id){
  if(id===SUPER_ADMIN_GAFETE){ alert("No puedes eliminar al Super Admin."); return; }
  await deleteDoc(doc(db,"users",id));
  cargarUsuarios();
}
window.editarUsuario=async function(id){
  const docu=await getDocs(collection(db,"users"));
  const userDoc=docu.docs.find(d=>d.id===id);
  if(!userDoc) return;
  const data=userDoc.data();
  const newNombre=prompt("Editar nombre:",data.nombre);
  const newRol=prompt("Editar rol (empleado/administrador):",data.rol);
  if(newNombre && newRol){ await setDoc(doc(db,"users",id),{ nombre:newNombre, gafete:data.gafete, rol:newRol }); cargarUsuarios(); }
}

// --- TARIMAS ---
function mostrarConfirmacionTarimas(){
  setView(`
    <p class="brand-title">CORNING</p>
    <div class="card">
      <h2>‚úÖ Registrar Tarima</h2>
      <button id="btnNuevaTarima" class="btn-orange">‚ûï Crear Nueva Tarima</button>
      <h4 id="folioActual"></h4>
      <div id="scanFeedback"></div>
      <input id="codigoTarima" placeholder="Escanear BX...">
      <button id="btnEscanear" class="btn-green">Agregar Caja</button>
      <p>Contador de cajas: <span id="counter">0</span></p>
      <hr>
      <h4>Cajas agrupadas por orden:</h4>
      <ul id="listaConfirmadas"></ul>
      <hr>
      <button id="btnConfirmar" class="btn-primary">‚úÖ Confirmar Tarima</button>
      <button id="btnSalir" class="btn-danger">‚ùå Cerrar Sesi√≥n</button>
      <div id="statusMessage"></div>
    </div>
  `);
  document.getElementById('btnNuevaTarima').onclick=crearNuevaTarima;
  document.getElementById('btnEscanear').onclick=escanearCaja;
  document.getElementById('codigoTarima').addEventListener('keypress',e=>{ if(e.key==='Enter') escanearCaja(); });
  document.getElementById('btnConfirmar').onclick=confirmarTarima;
  document.getElementById('btnSalir').onclick=cerrarSesion;
  actualizarContador();
}

async function crearNuevaTarima(){
  const folio=await generarNuevoFolio();
  tarimaActual={folio,cajas:[]};
  cajasTarima=[];
  document.getElementById('folioActual').textContent=`${folio} lista para escanear`;
  updateStatus('');
  renderTarima();
  actualizarContador();
}

function renderTarima(){
  const lista=document.getElementById('listaConfirmadas');
  const grouped={};
  cajasTarima.forEach(c=>{
    const orden=c.codigoCaja.slice(2,12);
    if(!grouped[orden]) grouped[orden]=[];
    grouped[orden].push(c.codigoCaja);
  });
  let html='';
  Object.entries(grouped).forEach(([orden,bx])=>{
    html+=`<li>
      <details>
        <summary>Orden: ${orden} (${bx.length} cajas)</summary>
        <ul>${bx.map(b=>`<li class="newScan">${b}</li>`).join('')}</ul>
      </details>
    </li>`;
  });
  lista.innerHTML=html||'<li>Sin cajas escaneadas</li>';
  actualizarContador();
}

function actualizarContador(){
  const counter=document.getElementById('counter');
  if(counter) { counter.textContent=cajasTarima.length; counter.classList.add('counterFlash'); setTimeout(()=>{counter.classList.remove('counterFlash');},500);}
}

function eliminarCaja(codigo){
  cajasTarima=cajasTarima.filter(c=>c.codigoCaja!==codigo);
  renderTarima();
}
window.eliminarCaja=eliminarCaja;

async function escanearCaja(){
  const codigo=document.getElementById('codigoTarima').value.trim().toUpperCase();
  if(!codigo.startsWith("BX")){ updateStatus("‚ùå El c√≥digo debe empezar con BX",'error'); return; }
  const orden=codigo.slice(2,12);
  cajasTarima.push({codigoCaja:codigo, numeroOrden:orden});
  renderTarima();
  document.getElementById('codigoTarima').value='';
  const feedback=document.getElementById('scanFeedback');
  feedback.textContent=`‚úÖ ${codigo} escaneada`;
  setTimeout(()=>{feedback.textContent='';},1800);
}

async function confirmarTarima(){
  if(!tarimaActual||cajasTarima.length===0){ updateStatus("‚ùå No hay tarima activa o sin cajas",'error'); return; }
  await addDoc(collection(db,"tarimas_confirmadas"),{
    folio: tarimaActual.folio,
    gafete: usuarioActual.gafete,
    usuario: usuarioActual.nombre,
    fecha: Timestamp.now(),
    cajas:cajasTarima
  });
  updateStatus('');
  abrirModal(`<p>‚úÖ Tarima ${tarimaActual.folio} confirmada exitosamente!</p>`);
  cajasTarima=[]; tarimaActual=null;
  document.getElementById('folioActual').textContent='';
  renderTarima();
  actualizarContador();
}

async function generarNuevoFolio(){
  const snapshot=await getDocs(collection(db,"tarimas_confirmadas"));
  let max=0;
  snapshot.forEach(docu=>{
    const folio=docu.data().folio;
    if(folio && folio.startsWith("TAR-")){
      const n=parseInt(folio.split("-")[1]);
      if(n>max) max=n;
    }
  });
  return `TAR-${(max+1).toString().padStart(3,'0')}`;
}

// --- CONSULTAR TARIMAS ---
async function consultarTarimas(){
  const snapshot=await getDocs(collection(db,"tarimas_confirmadas"));
  let html="<h3>Tarimas Confirmadas</h3><ul>";
  snapshot.forEach(docu=>{
    const t=docu.data();
    const folio=t.folio;
    const creador=t.gafete;
    const cajas=t.cajas||[];
    const grouped={};
    cajas.forEach(c=>{
      const orden=c.codigoCaja.slice(2,12);
      if(!grouped[orden]) grouped[orden]=[];
      grouped[orden].push(c.codigoCaja);
    });
    let detallesHTML="";
    Object.entries(grouped).forEach(([orden,bx])=>{
      detallesHTML+=`<details>
        <summary>Orden: ${orden} (${bx.length} cajas)</summary>
        <ul>${bx.map(b=>`<li>${b}</li>`).join('')}</ul>
      </details>`;
    });
    const fecha=t.fecha ? new Date(t.fecha.seconds*1000).toLocaleString() : '';
    html+=`<li class="tarimaBox">
      <b>${folio}</b>
      <details>
        <summary>Detalles</summary>
        <p>Fecha y Hora: ${fecha}</p>
        <p>Gafete: ${creador}</p>
        ${detallesHTML}
      </details>
    </li>`;
  });
  html+="</ul>";
  abrirModal(html);
}

function cerrarSesion(){ usuarioActual=null; mostrarLogin(); }

// --- INICIO ---
mostrarLogin();
</script>
</body>
</html>