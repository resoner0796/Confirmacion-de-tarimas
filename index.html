<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Tarimas Confirmadas - CORNING</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #FFFFFF;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      flex-direction: column;
    }
    .brand-title {
      font-family: 'Times New Roman', Times, serif;
      font-size: 42px;
      color: white;
      margin-bottom: 10px;
    }
    .card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 25px;
      border-radius: 20px;
      text-align: center;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    input, select {
      width: calc(100% - 20px);
      padding: 10px;
      margin: 8px 0;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.15);
      color: #fff;
    }
    button {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: bold;
      color: #fff;
    }
    .btn-primary { background-color: rgba(0,122,255,0.6); }
    .btn-green { background-color: rgba(76,175,80,0.6); }
    .btn-danger { background-color: rgba(255,59,48,0.6); }
    .btn-orange { background-color: rgba(255,193,7,0.7); color: #000; }
    #statusMessage { margin-top: 15px; font-weight: bold; }
    ul { list-style: none; padding: 0; text-align: left; }
    li { background: rgba(255,255,255,0.1); margin-bottom: 6px; padding: 8px; border-radius: 8px; }
  </style>
</head>
<body>

  <div id="app"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, getDocs, setDoc, doc, deleteDoc,
      query, where, orderBy, Timestamp 
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // --- CONFIGURACI√ìN FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyDtlj3ppT9WBGMR60SZx0TZmAo3BXQWDX0",
      authDomain: "rastreador-de-ordenes.firebaseapp.com",
      projectId: "rastreador-de-ordenes",
      storageBucket: "rastreador-de-ordenes.firebasestorage.app",
      messagingSenderId: "956052823395",
      appId: "1:956052823395:web:ca6127628e1dcf423cc756"
    };

    const appFB = initializeApp(firebaseConfig);
    const db = getFirestore(appFB);

    const SUPER_ADMIN_GAFETE = "528734";
    let usuarioActual = null;
    const appDiv = document.getElementById('app');

    // --- UI UTILIDADES ---
    function updateStatus(msg, type = 'info') {
      const el = document.getElementById('statusMessage');
      if (!el) return;
      el.textContent = msg;
      if (type === 'success') el.style.color = '#4CAF50';
      else if (type === 'error') el.style.color = '#FF5252';
      else el.style.color = '#9CA3AF';
    }

    function setView(html) {
      appDiv.innerHTML = html;
    }

    // --- LOGIN ---
    function mostrarLogin() {
      setView(`
        <p class="brand-title">CORNING</p>
        <div class="card">
          <h2>üîê Iniciar Sesi√≥n</h2>
          <p>Escanea o ingresa tu n√∫mero de gafete:</p>
          <input id="gafeteInput" type="text" placeholder="N√∫mero de gafete">
          <button id="btnLogin" class="btn-primary">Ingresar</button>
          <div id="statusMessage"></div>
        </div>
      `);
      document.getElementById('btnLogin').onclick = verificarGafete;
      document.getElementById('gafeteInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') verificarGafete();
      });
    }

    async function verificarGafete() {
      const gafete = document.getElementById('gafeteInput').value.trim();
      if (!gafete) { updateStatus("Ingresa tu gafete", 'error'); return; }

      try {
        const snapshot = await getDocs(collection(db, "users"));
        let userData = null;
        snapshot.forEach(docu => {
          const data = docu.data();
          if (data.gafete === gafete) userData = data;
        });

        if (!userData && gafete !== SUPER_ADMIN_GAFETE) {
          updateStatus("‚ùå Usuario no encontrado.", 'error');
          return;
        }

        if (gafete === SUPER_ADMIN_GAFETE && !userData) {
          userData = { nombre: "Super Admin", gafete, rol: "administrador" };
          await setDoc(doc(db, "users", gafete), userData);
        }

        usuarioActual = userData;
        updateStatus(`Bienvenido ${userData.nombre}`, 'success');
        setTimeout(() => {
          if (usuarioActual.rol === "administrador") mostrarAdministracion();
          else mostrarConfirmacionTarimas();
        }, 1000);
      } catch (e) {
        console.error(e);
        updateStatus("Error al conectar con Firestore.", 'error');
      }
    }

    // --- ADMINISTRACI√ìN ---
    async function mostrarAdministracion() {
      setView(`
        <p class="brand-title">CORNING</p>
        <div class="card">
          <h2>‚öôÔ∏è Administraci√≥n</h2>
          <input id="nombreUsuario" placeholder="Nombre del empleado">
          <input id="gafeteUsuario" placeholder="N√∫mero de gafete">
          <select id="rolUsuario">
            <option value="empleado">Empleado</option>
            <option value="administrador">Administrador</option>
          </select>
          <button id="btnAgregar" class="btn-green">üíæ Agregar Usuario</button>
          <hr>
          <h4>Usuarios Registrados:</h4>
          <ul id="listaUsuarios"></ul>
          <hr>
          <button id="btnSalir" class="btn-danger">‚ùå Cerrar Sesi√≥n</button>
          <div id="statusMessage"></div>
        </div>
      `);
      document.getElementById('btnAgregar').onclick = agregarUsuario;
      document.getElementById('btnSalir').onclick = cerrarSesion;
      cargarUsuarios();
    }

    async function cargarUsuarios() {
      const lista = document.getElementById('listaUsuarios');
      lista.innerHTML = '<li>Cargando...</li>';
      const snapshot = await getDocs(collection(db, "users"));
      let html = '';
      snapshot.forEach(docu => {
        const data = docu.data();
        html += `<li>${data.nombre} (${data.rol}) - Gafete: ${data.gafete}
        <button class="btn-danger" style="margin-top:5px;" onclick="eliminarUsuario('${docu.id}')">Eliminar</button></li>`;
      });
      lista.innerHTML = html || '<li>No hay usuarios registrados.</li>';
    }

    async function agregarUsuario() {
      const nombre = document.getElementById('nombreUsuario').value.trim();
      const gafete = document.getElementById('gafeteUsuario').value.trim();
      const rol = document.getElementById('rolUsuario').value;
      if (!nombre || !gafete) { updateStatus('‚ùå Completa todos los campos.', 'error'); return; }
      await setDoc(doc(db, "users", gafete), { nombre, gafete, rol });
      updateStatus('‚úÖ Usuario agregado.', 'success');
      document.getElementById('nombreUsuario').value = '';
      document.getElementById('gafeteUsuario').value = '';
      cargarUsuarios();
    }

    window.eliminarUsuario = async function(id) {
      if (id === SUPER_ADMIN_GAFETE) { alert("No puedes eliminar al Super Admin."); return; }
      await deleteDoc(doc(db, "users", id));
      cargarUsuarios();
    }

    // --- REGISTRO DE TARIMAS CONFIRMADAS ---
    function mostrarConfirmacionTarimas() {
      setView(`
        <p class="brand-title">CORNING</p>
        <div class="card">
          <h2>‚úÖ Registrar Tarima Confirmada</h2>
          <h4>Hola, ${usuarioActual.nombre}</h4>
          <input id="codigoTarima" placeholder="Escanear o ingresar BX...">
          <button id="btnConfirmar" class="btn-green">Confirmar</button>
          <hr>
          <h4>Confirmadas Hoy:</h4>
          <ul id="listaConfirmadas"></ul>
          <hr>
          <button id="btnSalir" class="btn-danger">‚ùå Cerrar Sesi√≥n</button>
          <div id="statusMessage"></div>
        </div>
      `);
      document.getElementById('btnConfirmar').onclick = confirmarTarima;
      document.getElementById('codigoTarima').addEventListener('keypress', e => {
        if (e.key === 'Enter') confirmarTarima();
      });
      document.getElementById('btnSalir').onclick = cerrarSesion;
      cargarConfirmadasHoy();
    }

    async function confirmarTarima() {
      const codigo = document.getElementById('codigoTarima').value.trim();
      if (!codigo.toUpperCase().startsWith('BX')) {
        updateStatus("‚ùå El c√≥digo debe empezar con 'BX'.", 'error');
        return;
      }
      try {
        await addDoc(collection(db, "tarimas_confirmadas"), {
          tarimaId: codigo,
          usuario: usuarioActual.nombre,
          gafete: usuarioActual.gafete,
          fechaHora: Timestamp.now()
        });
        updateStatus(`‚úÖ Tarima ${codigo} confirmada.`, 'success');
        document.getElementById('codigoTarima').value = '';
        cargarConfirmadasHoy();
      } catch (err) {
        console.error(err);
        updateStatus("‚ùå Error al guardar.", 'error');
      }
    }

    async function cargarConfirmadasHoy() {
      const lista = document.getElementById('listaConfirmadas');
      lista.innerHTML = '<li>Cargando...</li>';
      const hoy = new Date(); hoy.setHours(0, 0, 0, 0);
      const ma√±ana = new Date(hoy); ma√±ana.setDate(ma√±ana.getDate() + 1);
      const q = query(collection(db, "tarimas_confirmadas"), orderBy("fechaHora", "desc"));
      const snapshot = await getDocs(q);
      let html = "";
      snapshot.forEach(docu => {
        const d = docu.data();
        if (d.gafete === usuarioActual.gafete) {
          const fecha = d.fechaHora.toDate();
          if (fecha >= hoy && fecha < ma√±ana) {
            html += `<li>${d.tarimaId} ‚Äî ${fecha.toLocaleTimeString()}</li>`;
          }
        }
      });
      lista.innerHTML = html || '<li>No has confirmado tarimas hoy.</li>';
    }

    function cerrarSesion() {
      usuarioActual = null;
      mostrarLogin();
    }

    // --- INICIO ---
    mostrarLogin();
  </script>
</body>
</html>